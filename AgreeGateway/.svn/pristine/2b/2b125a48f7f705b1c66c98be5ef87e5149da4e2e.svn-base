/*
  Module Name: Data Views Creation & Details Page
  Author: AMIT

    1. FUNCTION 1 : Side bar toggler functionality
    2. FUNCTION 2 - Function for responsive of start and end date
    3. FUNCTION 3 - Calling Function "fetchDataViewDetails" to fetch route path and get details accordingly
    4. FUNCTION 4 - Checking duplicate view name
    5. FUNCTION 5 - Function calling on view select and deselect
    6. FUNCTION 6 - Function calling on selection of relation
    7. FUNCTION 7 - Function calling on selection of view column
    8. FUNCTION 8 - Function calling on de-selection of view column
    9. 

*/

import { Component, OnInit, OnDestroy, OnChanges, Input, AfterViewInit } from '@angular/core';
import { Response } from '@angular/http';
import { ActivatedRoute } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { Subscription } from 'rxjs/Rx';
import { JhiEventManager, JhiParseLinks, JhiPaginationUtil, JhiLanguageService, JhiAlertService } from 'ng-jhipster';
import { ITEMS_PER_PAGE, Principal } from '../../shared';
import { PaginationConfig } from '../../blocks/config/uib-pagination.config';
import { DataViews } from './data-views.model';
import { DataViewsService } from './data-views.service';
import { SelectItem, MultiSelectModule } from 'primeng/primeng';
import { PerfectScrollbarComponent } from 'angular2-perfect-scrollbar';
import { NgbDatepickerConfig, NgbDateStruct } from '@ng-bootstrap/ng-bootstrap';
import { Router, NavigationEnd } from '@angular/router';
import { JhiDateUtils } from 'ng-jhipster';
import { NotificationsService } from 'angular2-notifications-lite';
import { AngularMultiSelectModule } from 'angular2-multiselect-dropdown/angular2-multiselect-dropdown';
import { DataViewsColumnsService } from '../data-views-columns/data-views-columns.service';
import { CommonService } from '../common.service';
/* import { Angular2Csv } from 'angular2-csv/Angular2-csv'; */

declare var $: any;
declare var jQuery: any;
@Component({
    selector: 'jhi-data-views-detail',
    templateUrl: './data-views-detail.component.html'
})
export class DataViewsDetailComponent implements OnInit, OnDestroy {
    dataViews = new DataViews();
    fileTemplateList = [];
    operatorsList = [];
    dataTypeList = [];
    private subscription: any;
    eventSubscriber: Subscription;
    isCreateNew: boolean = false;
    isViewOnly: boolean = false;
    routeSub: any;
    presentPath: any;
    isEdit: boolean = false;
    parentPath = [];
    colField: boolean = false;
    columnEdit: boolean = false;
    showSelectedCol: boolean = false;
    savedCol: boolean = false;
    showColLov: boolean = false;
    addRowIcon: boolean = true;
    dropdownList = [];
    selectedItems = [];
    selectedColumns = [];
    dropdownSettings = {};
    limitSelectionSettings = {};
    basicExampleSettings: any = {};
    dropDownColumnList = [];
    dataViewsColumnsList = [];
    selectedviews = [];
    colTemplList: any = [];
    dataViewsPost: any = [];
    newData: boolean = false;
    filter: boolean = false;
    dataViewsVal: any = [];
    duplicateViewName: boolean = false;
    operator: any = [];
    colValue: any = [];
    excelFunctions = [];
    excelexpressioninput: any;
    excelexpressionExample: any;
    qualifierList = [];
    selectedRow: number = -1;
    rowSelected: boolean = true;
    viewRelations = [];
    selectedTemplates = [];
    viewRelation: any;
    basedTemplate: any;
    conditionLists = [];
    conditionList1: any;
    conditionList2: any;
    sourceName1: any;
    sourceName2: any;
    conditionValues: any = {};
    conditionsList: any = [];
    conditionEdit: boolean = false;
    sourceClick: boolean = false;
    targetClick: boolean = false;
    unionColumnsList = [];
    sourceCols: any = [];
    targetCols: any = [];
    unionSourceCol: any = [];
    unionTargetCol = [];
    conditionOperatorss: any;
    viewValidation: boolean = false;
    unionVal: boolean = false;
    qualifierList1: any = [];
    sourceTemplate: any = [];
    sourceColumns: any = [];
    sourceColumns1: any = [];
    columnsTemp: any = [];
    hideSaveButton: boolean = false;
    buttonFunction: boolean = true;
    groupByChecked: boolean;
    
    operatorss = [
        { value: '=', meaning: 'Equals' }
    ];
    excelFunctionsUnion = [{
        "lookUpCode": "ARITHMETIC_EXPRESSION",
        "meaning": "Arithmetic Expression",
        "description": "FT/DV.[SourceName1].Column1 operator FT/DV.[SourceName2].Column2"
    }];
    isVisibleA: boolean = false;
    constructor(
        private jhiLanguageService: JhiLanguageService,
        private dataViewsService: DataViewsService,
        private route: ActivatedRoute,
        private router: Router,
        private parseLinks: JhiParseLinks,
        private alertService: JhiAlertService,
        private principal: Principal,
        private activatedRoute: ActivatedRoute,
        private eventManager: JhiEventManager,
        private paginationUtil: JhiPaginationUtil,
        private paginationConfig: PaginationConfig,
        private config: NgbDatepickerConfig,
        private dateUtils: JhiDateUtils,
        private notificationsService: NotificationsService,
        private dataViewsColumnsService: DataViewsColumnsService,
        private commonService: CommonService
    ) {
        this.config.minDate = { year: 1950, month: 1, day: 1 };
        this.config.maxDate = { year: 2099, month: 12, day: 31 };
    }
   /*  ExportTable(){
				$("selectedColumnTable").tableExport({
				headings: true,                    // (Boolean), display table headings (th/td elements) in the <thead>
				footers: true,                     // (Boolean), display table footers (th/td elements) in the <tfoot>
				formats: ["xls"],    // (String[]), filetypes for the export
				fileName: "id",                    // (id, String), filename for the downloaded file
				bootstrap: true,                   // (Boolean), style buttons using bootstrap
				position: "well" ,                // (top, bottom), position of the caption element relative to table
				ignoreRows: null,                  // (Number, Number[]), row indices to exclude from the exported file
				ignoreCols: null,                 // (Number, Number[]), column indices to exclude from the exported file
				ignoreCSS: ".tableexport-ignore"   // (selector, selector[]), selector(s) to exclude from the exported file
			});
			}  */
    changeMinDate() {
        this.config.minDate = this.dataViews.startDate;
    }

    resetMinDate() {
        this.config.minDate = { year: 1950, month: 1, day: 1 };
    }

    ngOnInit() {
        this.showSelectedCol = false;
        this.commonService.screensize();
        $(".split-example").css({
            'height': 'auto',
            'min-height': (this.commonService.screensize().height - 130) + 'px'
        });
        this.getFileTemplateAndDataViews();

        this.dropdownSettings = {
            singleSelection: false,
            text: "Select Countries",
            selectAllText: 'Select All',
            unSelectAllText: 'UnSelect All',
            enableSearchFilter: true
        };
        this.limitSelectionSettings = {
            text: "Select Template / Data Source",
            selectAllText: 'Select All',
            unSelectAllText: 'UnSelect All',
            enableSearchFilter: true,
            classes: "myclass custom-class",
            limitSelection: 2,
            disabled: false
        };
        this.basicExampleSettings = {
            text: "Select Columns",
            selectAllText: 'Select All',
            unSelectAllText: 'UnSelect All',
            enableSearchFilter: true,
            classes: "myclass custom-class",
            disabled: false,
            badgeShowLimit: 2
        }
        /* Fetching Excel Function List */
        this.dataViewsService.operators('FUNCTIONS').subscribe((res: any) => {
            this.excelFunctions = res;
        });
        /* Fetching Operators List */
        this.dataViewsService.operators('All').subscribe((res: any) => {
            this.operatorsList = res;
        });
        /* Fetching Data Type List */
        this.dataViewsService.operators('DATA_TYPE').subscribe((res: any) => {
            this.dataTypeList = res;
        });
        /* Fetching Qualifiers List */
        this.dataViewsService.operators('RECON_QUALIFIERS').subscribe((res: any) => {
            this.qualifierList = res;
        });
        /* Fetching Relations List */
        this.dataViewsService.operators('DV_RELATION').subscribe((res: any) => {
            this.viewRelations = res;
        });
        /* Calling Function "fetchDataViewDetails" to fetch route path and get details accordingly*/
        this.fetchDataViewDetails();
    }

    /* FUNCTION 1 - Side bar toggler functionality 
       Author: AMIT 
    */
    toggleSB() {
        if (!this.isVisibleA) {
            this.isVisibleA = true;
            $('.split-example .left-component').addClass('visible');
        } else {
            this.isVisibleA = false;
            $('.split-example .left-component').addClass('visible');
        }
    }

    /* FUNCTION 2 - Function for responsive of start and end date
       Author: AMIT
       If Start Date Entered Apply Class 
    */
    startEndDateClass() {
        if (this.dataViews.startDate != null) {
            return 'col-md-3 col-sm-6 col-xs-12 form-group';
        } else {
            return 'col-md-4 col-sm-6 col-xs-12 form-group';
        }
    }

    /* FUNCTION 3 - Calling Function "fetchDataViewDetails" to fetch route path and get details accordingly
       Author: AMIT 
    */
    fetchDataViewDetails() {
        this.dataViewsColumnsList = [];
        this.subscription = this.route.params.subscribe(params => {
            let url = this.route.snapshot.url.map(segment => segment.path).join('/');
            this.presentPath = this.route.snapshot.url;
            if (this.presentPath == "data-views-new") {
                $('.component-title').removeClass('margin-left-22');
                this.newData = true;
            } else {
                $('.component-title').addClass('margin-left-22');
                this.newData = false;
            }
            if (params['id']) {
                this.sourceTemplate = [];
                this.dataViewsColumnsList = [];
                this.conditionOperatorss = "=";
                /* Calling service "getDataViewById" to get data views based on id */
                this.dataViewsService.getDataViewById(params['id']).subscribe(
                    (dataViews) => {
                        this.dataViews = dataViews[0];
                        this.isCreateNew = false;
                        if (url.endsWith('edit')) {
                            this.isEdit = true;
                        } else {
                            this.isViewOnly = true;
                        }
                        /* Three types of views "Single Template", "UNION" and "JOIN" */
                        if (this.dataViews.viewRelation != "UNION") {
                            this.showSelectedCol = true;
                            for (var i = 0; i < this.dataViews.dataViewsColumnsList.length; i++) {
                                this.dataViews.dataViewsColumnsList[i].colName = this.dataViews.dataViewsColumnsList[i].colName;
                                this.dataViewsColumnsList.push(this.dataViews.dataViewsColumnsList[i]);
                                this.showQualifier(this.dataViews.dataViewsColumnsList[i].colDataType, i);
                            }
                            console.log('this.dataViewsColumnsList ' + JSON.stringify(this.dataViewsColumnsList));
                            for (var x = 0; x < this.dataViews.templateInfo.length; x++) {
                                let obj = [{
                                    "type": this.dataViews.templateInfo[x].type,
                                    "typeId": this.dataViews.templateInfo[x].typeId
                                }];
                                this.dataViewsService.dataViewColTempList(obj).subscribe(
                                    (res: Response) => {
                                        this.columnsTemp = res;
                                        for (j = 0; j < this.columnsTemp.length; j++) {
                                            this.columnsTemp[j]['refDvColumn'] = this.columnsTemp[j].id;
                                            this.columnsTemp[j]['refDvName'] = this.columnsTemp[j].dataViewId;
                                            this.columnsTemp[j]['sourceName'] = this.columnsTemp[j].dataViewDisplayName;
                                            this.sourceColumns.push(this.columnsTemp[j]);
                                        }
                                        let temp = {
                                            "sourceName": this.columnsTemp[0].dataViewDisplayName,
                                            "refDvName": this.columnsTemp[0].dataViewId
                                        }
                                        this.sourceTemplate.push(temp);
                                    });
                            }
                            if (this.dataViews.conditions.length > 0) {
                                let obj1;
                                let obj2;
                                for (var j = 0; j < this.dataViews.conditions.length; j++) {
                                    obj1 = [{
                                        "id": this.dataViews.conditions[j].srcCol1,
                                        "type": this.dataViews.conditions[j].srcType1,
                                        "typeId": this.dataViews.conditions[j].scr1
                                    }];
                                    obj2 = [{
                                        "id": this.dataViews.conditions[j].srcCol2,
                                        "type": this.dataViews.conditions[j].srcType2,
                                        "typeId": this.dataViews.conditions[j].scr2
                                    }];
                                }
                                this.dataViewsService.dataViewColTempList(obj1).subscribe(
                                    (res: Response) => {
                                        this.conditionList1 = res;
                                        for (var i = 0; i < obj1.length; i++) {
                                            for (var j = 0; j < this.conditionList1.length; j++) {
                                                if (obj1[i].id == this.conditionList1[j].id) {
                                                    this.dataViews.source = this.conditionList1[j].id;
                                                    this.sourceName1 = this.conditionList1[j].templateName;
                                                }
                                                this.conditionList1[j]['refDvColumn'] = this.conditionList1[j].id;
                                                this.conditionList1[j]['refDvName'] = this.conditionList1[j].dataViewId;
                                                this.conditionList1[j]['sourceName'] = this.conditionList1[j].dataViewDisplayName;
                                            }
                                        }
                                        let temp = {
                                            "sourceName": this.conditionList1[0].dataViewDisplayName,
                                            "refDvName": this.conditionList1[0].dataViewId
                                        }
                                    });
                                this.dataViewsService.dataViewColTempList(obj2).subscribe(
                                    (res: Response) => {
                                        this.conditionList2 = res;
                                        for (var i = 0; i < obj2.length; i++) {
                                            for (var j = 0; j < this.conditionList2.length; j++) {
                                                if (obj2[i].id == this.conditionList2[j].id) {
                                                    this.dataViews.target = this.conditionList2[j].id;
                                                    this.sourceName2 = this.conditionList2[j].templateName;
                                                }
                                                this.conditionList2[j]['refDvColumn'] = this.conditionList2[j].id;
                                                this.conditionList2[j]['refDvName'] = this.conditionList2[j].dataViewId;
                                                this.conditionList2[j]['sourceName'] = this.conditionList2[j].dataViewDisplayName;
                                            }
                                        }
                                        let temp = {
                                            "sourceName": this.conditionList2[0].dataViewDisplayName,
                                            "refDvName": this.conditionList2[0].dataViewId
                                        }
                                    });
                            }
                                /* $('selectedColumnTable').tableExport({type:'excel'}); */
                        } else if (this.dataViews.viewRelation == "UNION") {
                            this.showSelectedCol = false;
                            this.unionColumnsList = this.dataViews.dataViewsUnionColumnsList;
                            let obj = [];
                            obj = this.dataViews.dataViewsUnionColumnsList;
                            let obj1;
                            let obj2;
                            for (var j = 0; j < obj[0].src.length; j++) {
                                obj1 = [{
                                    "type": obj[0].src[0].refDvType,
                                    "typeId": obj[0].src[0].refDvName
                                }];
                                obj2 = [{
                                    "type": obj[0].src[1].refDvType,
                                    "typeId": obj[0].src[1].refDvName
                                }];
                            }
                            this.selectedTemplates = [{
                                "dataName": ''
                            },
                            {
                                "dataName": ''
                            }];
                            this.dataViewsService.dataViewColTempList(obj1).subscribe(
                                (res: Response) => {
                                    this.sourceCols = res;
                                    for (var i = 0; this.sourceCols.length; i++) {
                                        this.sourceCols[i]['refDvColumn'] = this.sourceCols[i].id;
                                        this.sourceCols[i]['refDvName'] = this.sourceCols[i].dataViewId;
                                        this.selectedTemplates[0].dataName = this.sourceCols[0].dataViewDisplayName;
                                    }
                                });
                            this.dataViewsService.dataViewColTempList(obj2).subscribe(
                                (res: Response) => {
                                    this.targetCols = res;
                                    for (var i = 0; this.targetCols.length; i++) {
                                        this.targetCols[i]['refDvColumn'] = this.targetCols[i].id;
                                        this.targetCols[i]['refDvName'] = this.targetCols[i].dataViewId;
                                        this.selectedTemplates[1].dataName = this.targetCols[0].dataViewDisplayName;
                                    }
                                });
                            for (var i = 0; i < this.dataViews.dataViewsUnionColumnsList.length; i++) {
                                this.showQualifier(this.dataViews.dataViewsUnionColumnsList[i].colDataType, i);
                                this.dataViews.dataViewsUnionColumnsList[i]['sourceCol'] = this.dataViews.dataViewsUnionColumnsList[i].src[0].refDvColumn;
                                this.dataViews.dataViewsUnionColumnsList[i]['targetCol'] = this.dataViews.dataViewsUnionColumnsList[i].src[1].refDvColumn;
                            }
                        }
                    }
                );
            } else {
                this.isCreateNew = true;
                this.isVisibleA = true;
            }
        });
        console.log('data Source to display ' + JSON.stringify(this.dataViews));
    }

    

    /* FUNCTION 4 - Checking duplicate view name
       Author: AMIT 
    */
    checkViewName(val) {
        var count = 0;
        this.dataViewsService.dataViewList().subscribe((res: any) => {
            this.dataViewsVal = res;
            this.dataViewsVal.forEach(element => {
                let enteredName: string;
                enteredName = val.toLowerCase();
                let existingName: string;
                existingName = element.dataViewDispName.toLowerCase();
                if (existingName == enteredName) {
                    count++;
                }
            });
            if (count > 0) {
                this.duplicateViewName = true;
            } else {
                this.duplicateViewName = false;
            }
        });
    }

    /* FUNCTION 5 - Function calling on view select and deselect
       Author: AMIT 
    */
    onSelectTemplateAndDataView(item) {
        this.dropDownColumnList = [];
        this.dataViewsColumnsList = [];
        this.selectedColumns = [];
        this.selectedTemplates = item;
        this.viewRelation = '';
        this.basedTemplate = '';
        this.dataViews.source = '';
        this.dataViews.target = '';
        this.conditionList1 = [];
        this.conditionList2 = [];
        /* If colField is true showing field to select view relation else select column field */
        if (item.length == 1) {
            this.colField = true;
        } else {
            this.colField = false;
            this.selectedColumns = [];
        }
        /* Calling service function "dataViewColTempList" to fetch selected view columns */
         console.log('item temp :' + JSON.stringify(item));
        this.dataViewsService.dataViewColTempList(item).subscribe(
            (res: Response) => {
                this.colTemplList = res;
                     console.log('this.colTemplList :' + JSON.stringify(this.colTemplList));
                let count = 1;
                for (var i = 0; i < this.colTemplList.length; i++) {
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace("_", " ");
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace("_", " ");
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace("_", " ");
                    this.colTemplList[i].columnName = this.colTemplList[i].columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                    this.colTemplList[i]['refDvColumn'] = this.colTemplList[i].id;
                    this.colTemplList[i]['refDvName'] = this.colTemplList[i].dataViewId;
                    this.colTemplList[i].columnEdit = true;
                    for (var j = 0; j < item.length; j++) {
                        if (this.colTemplList[i].dataViewId == item[j].typeId) {
                            let obj = {
                                "id": count++,
                                "itemName": this.colTemplList[i].columnHeader + " - " + item[j].dataName,
                                "selColName": this.colTemplList[i].columnHeader,
                                "colId": this.colTemplList[i].dataViewId
                            }
                            this.dropDownColumnList.push(obj);
                        }
                    }
                }
            });
        if (this.selectedTemplates.length > 1) {
            const conOne = [];
            const conTwo = [];
            conOne.push(this.selectedTemplates[0]);
            conTwo.push(this.selectedTemplates[1]);
            this.dataViewsService.dataViewColTempList(conOne).subscribe(
                (res: Response) => {
                    this.conditionList1 = res;
                    this.sourceName1 = this.conditionList1[0].templateName;
                });
            this.dataViewsService.dataViewColTempList(conTwo).subscribe(
                (res: Response) => {
                    this.conditionList2 = res;
                    this.sourceName2 = this.conditionList2[0].templateName;
                });
        }
    }

    /* FUNCTION 6 - Function calling on selection of relation
       Author: AMIT 
    */
    relationFun(rel: any) {
        this.qualifierList1 = [];
        if (rel == 'UNION') {
            delete this.dataViews.dataViewsColumnsList;
            delete this.dataViews.basedTemplate;
            delete this.dataViews.conditions;
            this.selectedColumns = [];
            this.dataViewsColumnsList = [];
            this.basedTemplate = '';
            if (this.unionColumnsList.length > 0) {
                this.unionColumnsList = [];
                let obj = {
                    "columnEdit": true
                }
                this.unionColumnsList.push(obj);
            } else {
                let obj = {
                    "columnEdit": true
                }
                this.unionColumnsList.push(obj);
            }
            for (var i = 0; i < this.colTemplList.length; i++) {
                if (this.colTemplList[i].refDvName == this.selectedTemplates[0].typeId) {
                    this.sourceCols.push(this.colTemplList[i]);
                } else if (this.colTemplList[i].refDvName == this.selectedTemplates[1].typeId) {
                    this.targetCols.push(this.colTemplList[i]);
                }
            }
        } else {
            delete this.dataViews.unionColumnsList;
        }
    }

    /* FUNCTION 7 - Function calling on selection of view column
       Author: AMIT 
    */
    onColumnSelect(item) {
        this.filter = false;
        for (var j = 0; j < this.colTemplList.length; j++) {
            for (var i = 0; i < item.length; i++) {
                if (item[i].colId == this.colTemplList[j].dataViewId && item[i].selColName == this.colTemplList[j].columnHeader) {
                    this.colTemplList[j].colName = this.colTemplList[j].columnHeader;
                    this.colTemplList[j]['sourceName'] = this.colTemplList[j].dataViewDisplayName;
                    this.dataViewsColumnsList.push(this.colTemplList[j]);
                }
            }
        }
        this.dataViewsColumnsList = Array.from(this.dataViewsColumnsList.reduce((m, t) => m.set(t.columnName, t), new Map()).values());
        if (this.dataViewsColumnsList.length > 0) {
            this.showSelectedCol = true;
        }
    }

    /* FUNCTION 8 - Function calling on de-selection of view column
       Author: AMIT 
    */
    OnColumnDeSelect(item) {
        this.filter = false;
        this.dataViewsColumnsList = this.dataViewsColumnsList.filter(function (o1) {
            return item.some(function (o2) {
                return (o1.dataViewId === o2.colId && o1.columnHeader === o2.selColName) || (o1.dataViewId === undefined && o1.columnHeader === undefined); // return the ones with equal id
            });
        });
    }

    /* Function to display operator based on selected data type */
    showOperator(val, ind) {
        this.operatorsList[ind] = this.operatorsList.filter((item) => item.lookUpType == val);
    }

    showQualifier(val, ind) {
        for (var i = 0; i < this.qualifierList.length; i++) {
            if (val == "DECIMAL" && this.qualifierList[i].lookUpCode == 'AMOUNT') {
                this.qualifierList[i]['quali'] = val;
            } else if (val == "VARCHAR" && (this.qualifierList[i].lookUpCode == 'CURRENCYCODE' || this.qualifierList[i].lookUpCode == 'GROUPBY_COLUMN')) {
                this.qualifierList[i]['quali'] = val;
            } else if ((val == "DATE" || val == "DATETIME") && this.qualifierList[i].lookUpCode == 'TRANSDATE') {
                this.qualifierList[i]['quali'] = val;
            } else if (val == "BOOLEAN" || val == "INTEGER") {

            }
        }
        this.qualifierList1[ind] = this.qualifierList.filter((item) => item.quali == val);
    }

    displayColumns(id: any, ind: any) {
        this.sourceColumns1 = [];
        console.log('this.sourceColumns ' + JSON.stringify(this.sourceColumns));
        this.sourceColumns1 = this.sourceColumns.filter((item) => item.refDvName == id);
        console.log('sourceColumns1 ' + JSON.stringify(this.sourceColumns1));
        for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
            for(var j=0;j<this.sourceColumns1.length;j++){
                this.sourceColumns1[j].columnName = this.sourceColumns1[j].columnName.replace("_", " ");
                this.sourceColumns1[j].columnName = this.sourceColumns1[j].columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                if(this.dataViewsColumnsList[i].refDvColumn == this.sourceColumns1[j].refDvColumn){
                    this.sourceColumns1.splice(j,1);
                }
                if (ind == i) {
                    this.dataViewsColumnsList[ind]['columnName'] = '';
                }
            }
        }
    }

    setColumnName(col: any, ind: any) {
        for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
            if (ind == i) {
                this.dataViewsColumnsList[ind]['columnName'] = col.columnName;
            }
        }
    }

    listOperatorFun() {
        if (this.dataViewsColumnsList != null || this.dataViewsColumnsList != undefined) {
            for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
                this.showOperator(this.dataViewsColumnsList[i].colDataType, i);
            }
        }
    }

    /* Function to get file templates and data views list */
    getFileTemplateAndDataViews() {
        let count = 1;
        this.dataViewsService.fileTemplateList().subscribe((res: any) => {
            this.fileTemplateList = res;
           // console.log('this.fileTemplateList ' + JSON.stringify(this.fileTemplateList));
            for (var i = 0; i < this.fileTemplateList.length; i++) {
                if (this.fileTemplateList[i].status == 'Active') {
                    let obj = {
                        "id": count++,
                        "itemName": this.fileTemplateList[i].templateName + " - File Template",
                        "dataName": this.fileTemplateList[i].templateName,
                        "type": "File Template",
                        "typeId": this.fileTemplateList[i].id
                    }
                    this.dropdownList.push(obj);
                }
            }
        });
        /* As of now commenting dataview list */
        /* this.dataViewsService.dataViewList().subscribe((res:any)=>{
            this.dataViewsList = res;
            for(var i=0;i<this.dataViewsList.length;i++){
                let obj = {
                    "id": count++,
                    "itemName": this.dataViewsList[i].dataViewDispName + " - Data View",
                    "dataName": this.dataViewsList[i].dataViewDispName,
                    "type": "Data View",
                    "typeId": this.dataViewsList[i].id
                }
                this.dropdownList.push(obj);
            }
        }); */

        // console.log('File Template and Data Views List :' + JSON.stringify(this.dropdownList));
    }
    previousState() {
        window.history.back();
    }

    ngOnDestroy() {
        //this.subscription.unsubscribe();
    }






    saveColumns(val) {
        this.showSelectedCol = true;
        this.savedCol = true;
        this.basicExampleSettings = {
            text: "Select Columns",
            selectAllText: 'Select All',
            unSelectAllText: 'UnSelect All',
            enableSearchFilter: false,
            classes: "myclass custom-class",
            disabled: true
        }
    }
    /* Function to update and save dataview columns */
    updateColumnData(val: any) {
        console.log('DataView columns details while save/update :')
        if (val.colValue == null) {
            delete val.colValue;
        } else if (val.operator == null) {
            delete val.operator;
        }
        if (this.presentPath == "data-views-new") {

        } else {
            if (val.dataViewId == undefined) {
                val.dataViewId = this.dataViews.id;
                if (val.refDvName != null) {
                    val.refDvType = "File Template";
                }
            }
            console.log('val '+  JSON.stringify(val));
            val.columnName = val.columnName.replace("_", " ");
            val.columnName = val.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            this.dataViewsService.updateDataViewCol(val)
                .subscribe((res: any) => {
                    this.buttonFunction = true;
                    this.dataViewsService.createDataView(this.dataViews.id).subscribe((dataViews) => {

                    });
                    this.dataViewsColumnsList = [];
                    this.notificationsService.success(
                        'Success!',
                        'Column Data Successfully Updated'
                    )
                    this.fetchDataViewDetails();
                }
                );
        }
    }
    updateUnionColumnData(val: any, ind: any) {
        console.log('DataViewUnion details while save/update :' + JSON.stringify(val));
        val.columnName = val.columnName.replace("_", " ");
        val.columnName = val.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        val.columnName = val.columnName.replace("_", " ");
        val.columnName = val.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        val.columnName = val.columnName.replace("_", " ");
        val.columnName = val.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        val.columnName = val.columnName.replace("_", " ");
        val.columnName = val.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        if (val.id != null) {
            //   console.log('update :' + JSON.stringify(val));

            this.testAr = [];

            for (var j = 0; j < this.sourceCols.length; j++) {
                for (var x = 0; x < this.targetCols.length; x++) {
                    for (var i = 0; i < val.src.length; i++) {
                        if (val.sourceCol == this.sourceCols[j].refDvColumn && val.targetCol == this.targetCols[x].refDvColumn) {
                            delete this.sourceCols[j].id;
                            delete this.targetCols[x].id;
                            this.sourceCols[j]['id'] = val.src[0].id;
                            this.targetCols[x]['id'] = val.src[1].id;
                            this.testAr.push(this.sourceCols[j]);
                            this.testAr.push(this.targetCols[x]);

                        }
                    };
                }
            }
            delete val.src;
            val.src = this.testAr;
            //console.log('to update :' + JSON.stringify(val));
            this.dataViewsService.updateUnionDataViewCol(val)
                .subscribe((res: any) => {
                    this.buttonFunction = true;
                    this.dataViewsService.createDataView(this.dataViews.id).subscribe((dataViews) => {

                    });
                    this.dataViewsColumnsList = [];
                    this.notificationsService.success(
                        'Success!',
                        'Column Data Successfully Updated'
                    )
                    this.fetchDataViewDetails();
                });
        } else {
            //console.log('this.dataViews.id ' + this.dataViews.id);
            val.dataViewId = this.dataViews.id;
            if (val.formula == '' || val.formula == undefined || val.formula == null) {
                let count = -1;
                this.testAr = [];

                count++;
                val['index'] = count;
                for (var j = 0; j < this.sourceCols.length; j++) {
                    for (var x = 0; x < this.targetCols.length; x++) {
                        /* console.log('this.sourceCols ' + JSON.stringify(this.sourceCols));
                        console.log('this.targetCols ' + JSON.stringify(this.targetCols));
                        console.log(val.sourceCol);
                        console.log(val.targetCol); */
                        if (val.sourceCol == this.sourceCols[j].refDvColumn && val.targetCol == this.targetCols[x].refDvColumn) {
                            this.testAr.push(this.sourceCols[j]);
                            this.testAr.push(this.targetCols[x]);
                            val.src = this.testAr;
                        }
                    }
                }
                val.src.forEach(element => {
                    delete element.id;
                });
            }

            //console.log('to updd union ' + JSON.stringify(val));
            this.dataViewsService.updateUnionDataViewCol(val)
                .subscribe((res: any) => {
                    this.buttonFunction = true;
                    this.dataViewsService.createDataView(this.dataViews.id).subscribe((dataViews) => {

                    });
                    this.dataViewsColumnsList = [];
                    this.notificationsService.success(
                        'Success!',
                        'Column Data Successfully Updated'
                    )
                    this.fetchDataViewDetails();
                });
        }
    }
    deleteColumn(val: any, ind: any) {
        console.log('Data Source columns details while delete :' + JSON.stringify(val));
        /* console.log('ind ' + ind);
        console.log('qualifierList1 ' + JSON.stringify(this.qualifierList1)); */
        /* console.log('dataViewsColumnsList ' + JSON.stringify(this.dataViewsColumnsList)); */
        // console.log('selectedColumns ' + JSON.stringify(this.selectedColumns));
        if (this.dataViewsColumnsList.length > 1) {
            if (this.presentPath == "data-views-new") {
                let temp = [];
                if (val.id) {
                    for (var a = 0; a < this.selectedColumns.length; a++) {
                        if (this.selectedColumns[a].colId == val.refDvName && this.selectedColumns[a].selColName == val.columnHeader) {
                            /*  console.log('a ' + a);
                             console.log('if ' + this.selectedColumns[a].colId +  ' ' + val.refDvName);
                             console.log('if ' + this.selectedColumns[a].selColName +  ' ' + val.columnHeader); */
                            this.selectedColumns.splice(a, 1);
                        }
                    }
                    //console.log('selectedColumns ' + JSON.stringify(this.selectedColumns));
                }

                for (var i = 0; i < this.dataViewsColumnsList.length; i++) {

                    /*  for(var a=0;a<this.selectedColumns.length;a++){
                         if(this.dataViewsColumnsList[i].refDvName == this.selectedColumns[a].colId && this.dataViewsColumnsList[i].colName == this.selectedColumns[a].selColName){
                             this.selectedColumns.splice(a, 1);
                         } */
                    if (ind == i) {
                        // console.log('this.qualifierList1[ind] ' + JSON.stringify(this.qualifierList1[ind]));
                        this.dataViewsColumnsList[i].colDataType = '';
                        delete this.qualifierList1[ind];
                        this.dataViewsColumnsList.splice(this.dataViewsColumnsList.indexOf(val), 1);
                    }

                    /* } */

                }
                for (var j = 0; j < this.qualifierList1.length; j++) {
                    if (this.qualifierList1[j]) {
                        temp.push(this.qualifierList1[j]);
                    }
                    //  console.log('tem ' + JSON.stringify(temp));
                }
                this.qualifierList1 = temp;

                /* console.log('qualifierList1 del ' + JSON.stringify(this.qualifierList1));
                console.log('dataViewsColumnsList del ' + JSON.stringify(this.dataViewsColumnsList)); */
                // console.log('selectedColumns ' + JSON.stringify(this.selectedColumns));
            } else {
                // console.log('in details :' + JSON.stringify(val));
                this.dataViewsService.deleteDataViewCol(val.id).subscribe(response => {
                    this.dataViewsColumnsList.splice(this.dataViewsColumnsList.indexOf(val), 1);
                    this.dataViewsService.createDataView(this.dataViews.id)
                        .subscribe((dataViews) => {

                        });
                    this.notificationsService.success(
                        'Success!',
                        'Column Deleted Successfully'
                    )
                });
            }
        } else {
            this.notificationsService.error(
                'Warning!',
                'Atleast one column is mandatory'
            )
        }

    }

    deleteUnionColumn(val: any, ind: any) {
        console.log('dataViewUnion Details while Del :' + JSON.stringify(val));
        /* console.log('ind ' + ind);
        console.log('this.unionColumnsList ' + JSON.stringify(this.unionColumnsList));
        console.log('qualifierList1 ' + JSON.stringify(this.qualifierList1));  */
        if (this.unionColumnsList.length > 1) {
            if (this.presentPath == "data-views-new") {
                let temp = [];
                for (var i = 0; i < this.unionColumnsList.length; i++) {
                    if (ind == i) {
                        this.unionColumnsList[i].colDataType = '';
                        delete this.qualifierList1[ind];
                        this.unionColumnsList.splice(this.unionColumnsList.indexOf(val), 1);
                    }
                }
                for (var j = 0; j < this.qualifierList1.length; j++) {
                    if (this.qualifierList1[j]) {
                        temp.push(this.qualifierList1[j]);
                    }
                }
                this.qualifierList1 = temp;

            } else {
                this.dataViewsService.deleteUnionDataViewCol(val.id).subscribe(response => {
                    let result: any = response;
                    this.dataViewsService.createDataView(this.dataViews.id)
                        .subscribe((dataViews) => {

                        });
                    this.fetchDataViewDetails();
                    this.notificationsService.success(
                        'Success!',
                        'Column "' + result.columnName + '" Deleted Successfully'
                    )
                });
            }
        } else {
            this.notificationsService.error(
                'Warning!',
                'Atleast one column is mandatory'
            )
        }

    }
    addUnionColumn() {
        // console.log('unionColumnsList ' + JSON.stringify(this.unionColumnsList));
        let count = 0;
        for (var i = 0; i < this.unionColumnsList.length; i++) {
            if (this.unionColumnsList[i].columnName == '' || this.unionColumnsList[i].colDataType == '' ||
                this.unionColumnsList[i].columnName == undefined || this.unionColumnsList[i].colDataType == undefined) {
                count++;
            }
        }
        if (count > 0) {
            this.notificationsService.error(
                'Warning!',
                'Fill is mandatory fields to add another column'
            )
        } else {
            let obj = {
                "columnEdit": true
            }
            this.unionColumnsList.push(obj);
            //  console.log('unionColumnsList ' + JSON.stringify(this.unionColumnsList));
        }

    }

    cancelColumnChanges(ind: any) {
        this.sourceColumns1 = [];
        this.sourceColumns = [];
        // console.log('canceled' + ind);
        this.unionColumnsList.forEach(element => {
            if (element.id == undefined) {
                this.unionColumnsList.splice(ind, 1);
            }
        });
        this.fetchDataViewDetails();
    }
    cancelUnionColumnChanges(ind: any) {
        //  console.log('canceled' + ind);
        this.dataViewsColumnsList.forEach(element => {
            if (element.id == undefined) {
                this.dataViewsColumnsList.splice(ind, 1);
            }
        });

        this.fetchDataViewDetails();
        // console.log('on cancel :' + JSON.stringify(this.dataViewsColumnsList));
    }
    addColumn() {
        let count = 0;
        for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
            if (this.dataViewsColumnsList[i].columnName == '' || this.dataViewsColumnsList[i].colDataType == '' ||
                this.dataViewsColumnsList[i].columnName == undefined || this.dataViewsColumnsList[i].colDataType == undefined) {
                count++;
            }
        }
        if (count > 0) {
            this.notificationsService.error(
                'Warning!',
                'Fill mandatory fields to add another column'
            )
        } else {
            let newLine = {
                "columnEdit": true
            };
            this.dataViewsColumnsList.push(newLine);
            this.filter = false;
        }
    }

    /* Function to show/hide filter columns */
    applyFilter() {
        let count = 0;
        //  console.log('dataViewsColumnsList :' + JSON.stringify(this.dataViewsColumnsList));
        this.dataViewsColumnsList.forEach(element => {
            if (element.colDataType === null || element.colDataType === undefined || element.colDataType === '') {
                count++;
            }
        });
        if (count > 0) {
            this.notificationsService.error(
                'Warning!',
                'Data Type is mandatory to apply filter'
            )
        } else {
            if (this.filter == true) {
                this.filter = false;
            } else {
                this.filter = true;
            }
        }
    }
    sourceCall(obj: any) {
        // console.log('source obj :' + JSON.stringify(obj));
        this.conditionValues.srcType1 = obj.refDvType;
        this.conditionValues.scr1 = obj.dataViewId;
        this.conditionValues.srcCol1 = obj.id;
        this.sourceClick = true;

    }
    targetCall(obj: any) {
        //  console.log('source obj :' + JSON.stringify(obj));
        this.conditionValues.srcType2 = obj.refDvType;
        this.conditionValues.scr2 = obj.dataViewId;
        this.conditionValues.srcCol2 = obj.id;
        this.conditionValues.conditionOperator = "=";
        this.targetClick = true;
    }
    testAr = [];
    /* Function to save and update data view */
    saveDataViews() {
        this.hideSaveButton = true;
        let count = 0;
        this.dataViews['viewRelation'] = this.viewRelation;
        this.dataViews['basedTemplate'] = this.basedTemplate;
        let link: any = '';

        if (this.dataViews.id !== undefined) {

            this.dataViewsPost.push(this.dataViews);
            delete this.dataViewsPost[0].dataViewsColumnsList;
            delete this.dataViewsPost[0].dataViewsUnionColumnsList;
            console.log('data source detail to update :' + JSON.stringify(this.dataViewsPost));
            this.dataViewsService.postDataViews(this.dataViewsPost)
                .subscribe((dataViews) => {
                    this.dataViews = dataViews;
                    this.notificationsService.success(
                        'Success!',
                        'Successfully Updated Data Source'
                    )
                    this.hideSaveButton = false;
                    if (this.dataViews.id) {
                        link = ['/data-views', { outlets: { 'content': this.dataViews.id + '/details' } }];
                        this.router.navigate(link);
                    }
                    this.dataViewsService.createDataView(this.dataViews.id)
                        .subscribe((dataViews) => {

                        });
                });
        } else {
            if ((this.dataViews.viewRelation === null || this.dataViews.viewRelation === undefined || this.dataViews.viewRelation === '') &&
                (this.dataViews.basedTemplate === null || this.dataViews.basedTemplate === undefined || this.dataViews.basedTemplate === '')) {
                delete this.dataViews.basedTemplate;
                delete this.dataViews.viewRelation;
            } else {
                this.conditionsList.push(this.conditionValues);
                this.dataViews['conditions'] = this.conditionsList;
            }

            if (this.dataViews.viewRelation != 'UNION') {
                this.dataViews['dataViewsColumnsList'] = this.dataViewsColumnsList;
            } else {
                let count = -1;
                for (var i = 0; i < this.unionColumnsList.length; i++) {
                    this.testAr = [];
                    count++;
                    this.unionColumnsList[i]['index'] = count;
                    for (var j = 0; j < this.sourceCols.length; j++) {
                        for (var x = 0; x < this.targetCols.length; x++) {
                            if (this.unionColumnsList[i].sourceCol == this.sourceCols[j].refDvColumn && this.unionColumnsList[i].targetCol == this.targetCols[x].refDvColumn
                                && this.unionColumnsList[i].index == i) {
                                this.testAr.push(this.sourceCols[j]);
                                this.testAr.push(this.targetCols[x]);
                                this.unionColumnsList[i].src = this.testAr;
                            }
                        }
                    }
                }
                delete this.dataViews.conditions;
                delete this.dataViews.basedTemplate;
                this.dataViews['dataViewsUnionColumnsList'] = this.unionColumnsList;
            }
            this.dataViews['enabledFlag'] = true;
            this.dataViewsPost.push(this.dataViews);
            //   console.log('data view while post :' + JSON.stringify(this.dataViewsPost));
            if (this.dataViews.viewRelation != 'UNION') {
                this.saveDataViewsV();
            } else {

                this.viewValidation = true;
            }

            if (this.viewValidation == true) {
                /*  if(this.dataViewsPost[0].conditions.length>1){
                     this.dataViewsPost[0].conditions = Array.from(this.dataViewsPost[0].conditions.reduce((m, t) => m.set(t.scr1, t), new Map()).values());
                 } */
                
                console.log('data source while posting after validation :' + JSON.stringify(this.dataViewsPost));
                this.dataViewsService.postDataViews(this.dataViewsPost)
                    .subscribe((dataViews) => {
                        this.dataViews = dataViews;
                        this.dataViewsService.createDataView(this.dataViews.id)
                            .subscribe((dataViews) => {

                            });
                        this.notificationsService.success(
                            'Success!',
                            'Successfully Data Source Created'
                        )
                        this.hideSaveButton = false;
                        if (this.dataViews.id) {
                            link = ['/data-views', { outlets: { 'content': this.dataViews.id + '/details' } }];
                            if (this.isEdit) {
                                this.isEdit = false;
                            }
                            if (this.isCreateNew) {
                                this.isCreateNew = false;
                            }
                            this.isViewOnly = true;
                            this.router.navigate(link);
                        }

                    },
                (res: Response) => {
                    this.onError(res.json()
                    )
                    this.notificationsService.error('Error!', 'Something Went Wrong');
                    this.hideSaveButton = false;
                });
            }


        }

    }
    private onError(error) {
        this.alertService.error(error.message, null, null);
    }
    saveDataViewsU() {
        console.log('on union save validation :' + JSON.stringify(this.unionColumnsList));
        this.unionColumnsList.forEach(element => {
            element.columnName = element.columnName.replace("_", " ");
            element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            element.columnName = element.columnName.replace("_", " ");
            element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            element.columnName = element.columnName.replace("_", " ");
            element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            element.columnName = element.columnName.replace("_", " ");
            element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        });
        
        if (this.unionColumnsList) {
            let count = 0;
            let intcount = 0;
            let datecount = 0;
            let datecountint = 0;
            let currcount = 0;
            let currcountint = 0;
            let datecountint1 = 0;
            let datecount1 = 0;
            let groupByCount = 0;
            for (var i = 0; i < this.unionColumnsList.length; i++) {
                if (this.unionColumnsList[i].colDataType == '' || this.unionColumnsList[i].colDataType == null) {
                    this.hideSaveButton = false;
                    this.notificationsService.error(
                        'Warning!',
                        'Data Type is Mandatory'
                    )
                } else if (this.unionColumnsList[i].colDataType == 'DATE') {
                    datecountint++;
                    // console.log('datecount ' + datecount);
                    if (this.unionColumnsList[i].qualifier == 'TRANSDATE') {
                        datecount++;
                        //   console.log('datecountint ' + datecountint);
                    }
                } else if (this.unionColumnsList[i].colDataType == 'DATETIME') {
                    datecountint1++;
                    // console.log('datecount ' + datecount);
                    if (this.unionColumnsList[i].qualifier == 'TRANSDATE') {
                        datecount1++;
                        //    console.log('datecountint ' + datecountint);
                    }
                }else if (this.unionColumnsList[i].groupBy) {
                    if(this.unionColumnsList[i].groupBy == true){
                        groupByCount++;
                    }
                        console.log('groupByCount ' + groupByCount);
                } else if (this.unionColumnsList[i].qualifier != '' || this.unionColumnsList[i].qualifier == undefined || this.unionColumnsList[i].qualifier == '') {
                    if (this.unionColumnsList[i].qualifier == 'AMOUNT') {
                        count++;
                        //  console.log('amount = : ' + count);
                        if (this.unionColumnsList[i].colDataType == 'DECIMAL') {
                            intcount++;
                            //    console.log('amount = integer : ' + intcount);
                        }
                        //  console.log('in amount ' + count);
                    } else if (this.unionColumnsList[i].qualifier == 'CURRENCYCODE' || this.unionColumnsList[i].qualifier == 'GROUPBY_COLUMN') {
                        currcount++;
                        //  console.log('currcount ' + currcount);
                        if (this.unionColumnsList[i].colDataType == 'VARCHAR') {
                            currcountint++;
                            //    console.log('currcountint ' + currcountint);
                        }
                    }
                } else {
                    this.saveDataViews();
                }
            }

            if (count > 1) {
                //  console.log('in amount >1 : ' + count);
                this.hideSaveButton = false;
                this.notificationsService.error(
                    'Warning!',
                    '"Amount" qualifier should be tagged only to one column with data type "DECIMAL"'
                )
            } else if (count == 1) {
                // console.log('in amount=1 : ' + count);
                if (intcount == 1) {
                    //this.saveDataViews();
                } else {
                    this.hideSaveButton = false;
                    this.notificationsService.error(
                        'Warning!',
                        'Data type of "Amount" qualifier should be of type "DECIMAL"'
                    )
                }
            } else if (count < 1) {
                //   console.log('in amount<1 :' + count);
                this.hideSaveButton = false;
                this.notificationsService.error(
                    'Warning!',
                    '"Amount" qualifier is mandatory'
                )
            }

            if (datecountint > 0 && datecount < 1) {
                this.hideSaveButton = false;
                this.notificationsService.error(
                    'Warning!',
                    '"TRANSDATE" qualifier should be tagged to data type "DATE"'
                )
            }
            if (datecountint1 > 0 && datecount1 < 1) {
                this.hideSaveButton = false;
                this.notificationsService.error(
                    'Warning!',
                    '"TRANSDATE" qualifier should be tagged to data type "DATETIME"'
                )
            }
            /* if (datecount > 1) {
                console.log('in datecount >1 : ' + datecount);
                this.notificationsService.error(
                    'Warning!',
                    '"TRANSDATE" qualifier should be tagged only to one column with data type "DATE" or "DATETIME"'
                )
            } else if (datecount == 1) {
                console.log('in datecount=1 : ' + datecount);
                console.log('in datecountint=1 : ' + datecountint);
                if (datecountint == 1) {
                    //this.saveDataViews();
                } else {
                    this.notificationsService.error(
                        'Warning!',
                        'Data type of "TRANSDATE" qualifier should be "DATE" or "DATETIME"'
                    )
                }
            } *//*  else if (datecount < 1) {
                console.log('in datecount<1 :' + datecount);
                this.notificationsService.error(
                    'Warning!',
                    '"TRANSDATE" qualifier is mandatory'
                )
            } */

            if (currcount > 1) {
                //  console.log('in currcount >1 : ' + currcount);
                this.hideSaveButton = false;
                this.notificationsService.error(
                    'Warning!',
                    '"CURRENCY" qualifier should be tagged only to one column with data type "VARCHAR'
                )
            } else if (currcount == 1) {
                //  console.log('in currcount=1 : ' + currcount);
                if (currcountint == 1) {
                } else {
                    this.hideSaveButton = false;
                    this.notificationsService.error(
                        'Warning!',
                        'Data type of "TRANSDATE" qualifier should be "VARCHAR"'
                    )
                }
            }
            if (groupByCount == 0) {
                    this.notificationsService.error(
                        'Warning!',
                        'Atleast one "Group By" column should be selected'
                    )
                    this.hideSaveButton = false;
                }
            console.log('groupByCount ' +groupByCount);
            if ((count == 1 && intcount == 1) && (datecount == datecountint) && (datecount1 == datecountint1) && groupByCount>0) {
                this.saveDataViews();
            }

        }


    }
    /* Function to display validition message */
    validationMsg() {
        if (this.duplicateViewName == true) {
            this.hideSaveButton = false;
            this.notificationsService.error(
                'Warning!',
                'Display Name already exists'
            )
        } else if (this.duplicateViewName == false) {
            this.hideSaveButton = false;
            this.notificationsService.error(
                'Warning!',
                'Fill Mandatory Fields'
            )
        } else if (this.dataViewsColumnsList.length < 1) {
            this.hideSaveButton = false;
            this.notificationsService.error(
                'Warning!',
                'Select atleast one column'
            )
        }
    }


    showExcelFunction(val, ind, examp) {
        for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
            if (i == ind) {
                this.dataViewsColumnsList[i]['excelexpressioninput'] = val;
                this.dataViewsColumnsList[i]['excelexpressionExample'] = examp;
            }
        }
    }

    showExcelUnionFunction(val, ind, examp) {
        for (var i = 0; i < this.unionColumnsList.length; i++) {
            if (i == ind) {
                this.unionColumnsList[i]['excelexpressioninputUnion'] = val;
                this.unionColumnsList[i]['excelexpressionExampleUnion'] = examp;
            }
        }
    }

    saveExpression(val, ind, frml) {

        /*  console.log('save ' + JSON.stringify(val));
         console.log('ind ' + ind);
         console.log('frml ' + frml); */
        for (var i = 0; i < this.dataViewsColumnsList.length; i++) {
            if (i == ind) {
                if (val) {
                    this.dataViewsColumnsList[i]['formula'] = val;
                } else {
                    this.dataViewsColumnsList[i]['formula'] = frml;
                }

            }
        }
    }

    insertUnionExpression(val, ind, frml) {
        for (var i = 0; i < this.unionColumnsList.length; i++) {
            if (i == ind) {
                if (val) {
                    this.unionColumnsList[i]['formula'] = val;
                } else {
                    this.unionColumnsList[i]['formula'] = frml;
                }
            }
        }
    }

    /* Function to update conditions */
    updateConditions() {
        this.conditionValues.filterOperator = '=';
        this.conditionValues.dataViewId = this.dataViews.id;
        this.conditionValues.id = this.dataViews.conditions[0].id;
        if (this.sourceClick == false) {
            this.conditionValues.refSrcType = this.dataViews.conditions[0].srcType1;
            this.conditionValues.refSrcId = this.dataViews.conditions[0].scr1;
            this.conditionValues.refSrcColId = this.dataViews.conditions[0].srcCol1;
        } else {
            this.conditionValues.refSrcType = this.conditionValues.srcType1;
            this.conditionValues.refSrcId = this.conditionValues.scr1;
            this.conditionValues.refSrcColId = this.conditionValues.srcCol1;
        }
        if (this.targetClick == false) {
            this.conditionValues.refSrcType2 = this.dataViews.conditions[0].srcType2;
            this.conditionValues.refSrcId2 = this.dataViews.conditions[0].scr2;
            this.conditionValues.refSrcColId2 = this.dataViews.conditions[0].srcCol2;
        } else {
            this.conditionValues.refSrcType2 = this.conditionValues.srcType2;
            this.conditionValues.refSrcId2 = this.conditionValues.scr2;
            this.conditionValues.refSrcColId2 = this.conditionValues.srcCol2;
        }
        this.dataViewsService.conditionUpdate(this.conditionValues).subscribe((res: any) => {
            this.dataViewsService.createDataView(this.dataViews.id)
                .subscribe((dataViews) => {

                });
            this.fetchDataViewDetails();
        });
    }

    cancelConditionChanges() {
        this.fetchDataViewDetails();
    }

    /* function for validation */

    saveDataViewsV() {
        console.log('data source detailsV for validation :' + JSON.stringify(this.dataViews));
         
        let temp = [];
        var unique;
        this.dataViews.dataViewsColumnsList.forEach(element => {
            if (element.refDvName) {
                temp.push(element.refDvName);
            }
            if(element.columnName){
                element.columnName = element.columnName.replace("_", " ");
                element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                element.columnName = element.columnName.replace("_", " ");
                element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                element.columnName = element.columnName.replace("_", " ");
                element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                element.columnName = element.columnName.replace("_", " ");
                element.columnName = element.columnName.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
            }
            unique = temp.filter(function (item, i, ar) { return ar.indexOf(item) === i; });
            //   console.log('temp count ' + JSON.stringify(unique));
        });
        if ((unique.length > 1) || (this.dataViews.viewRelation == '' || this.dataViews.viewRelation == undefined || this.dataViews.viewRelation == null)) {
            if (this.dataViews.dataViewsColumnsList) {
                let count = 0;
                let intcount = 0;
                let datecount = 0;
                let datecountint = 0;
                let currcount = 0;
                let currcountint = 0;
                let groupcount = 0;
                let groupcountint = 0;
                let datecountint1 = 0;
                let datecount1 = 0;
                let groupByCount = 0;
                for (var i = 0; i < this.dataViews.dataViewsColumnsList.length; i++) {
                    if (this.dataViews.dataViewsColumnsList[i].colDataType == '' || this.dataViews.dataViewsColumnsList[i].colDataType == null) {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Data Type is Mandatory'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;
                    } else if (this.dataViews.dataViewsColumnsList[i].colDataType == 'DATE') {
                        datecountint++;
                        // console.log('datecount ' + datecount);
                        if (this.dataViews.dataViewsColumnsList[i].qualifier == 'TRANSDATE') {
                            datecount++;
                            //   console.log('datecountint ' + datecountint);
                        }
                    } else if (this.dataViews.dataViewsColumnsList[i].colDataType == 'DATETIME') {
                        datecountint1++;
                        //  console.log('datecount ' + datecount);
                        if (this.dataViews.dataViewsColumnsList[i].qualifier == 'TRANSDATE') {
                            datecount1++;
                            //    console.log('datecountint ' + datecountint);
                        }
                    } else if (this.dataViews.dataViewsColumnsList[i].groupBy) {
                        groupByCount++;
                    } else if (this.dataViews.dataViewsColumnsList[i].qualifier != '' || this.dataViews.dataViewsColumnsList[i].qualifier == undefined || this.dataViews.dataViewsColumnsList[i].qualifier == '') {
                        if (this.dataViews.dataViewsColumnsList[i].qualifier == 'AMOUNT') {
                            count++;
                            //   console.log('amount = : ' + count);
                            if (this.dataViews.dataViewsColumnsList[i].colDataType == 'DECIMAL') {
                                intcount++;
                                console.log('amount = integer : ' + intcount);
                            }
                            //   console.log('in amount ' + count);
                        } else if (this.dataViews.dataViewsColumnsList[i].qualifier == 'CURRENCYCODE') {
                            currcount++;
                            //    console.log('currcount ' + currcount);
                            if (this.dataViews.dataViewsColumnsList[i].colDataType == 'VARCHAR') {
                                currcountint++;
                                //       console.log('currcountint ' + currcountint);
                            }
                        } else if (this.dataViews.dataViewsColumnsList[i].qualifier == 'GROUPBY_COLUMN') {
                            groupcount++;
                            //    console.log('currcount ' + currcount);
                            if (this.dataViews.dataViewsColumnsList[i].colDataType == 'VARCHAR') {
                                groupcountint++;
                                //       console.log('currcountint ' + currcountint);
                            }
                        }
                    } else if (this.dataViews.dataViewsColumnsList[i].columnName == '' || this.dataViews.dataViewsColumnsList[i].columnName == null) {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Display Name is Mandatory'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;
                    } else if ((this.dataViews.dataViewsColumnsList[i].operator != null) && (this.dataViews.dataViewsColumnsList[i].colValue == '' || this.dataViews.dataViewsColumnsList[i].colValue == null || this.dataViews.dataViewsColumnsList[i].colValue == undefined)) {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Value is Mandatory for selected operator'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;


                    } else if (this.dataViews.dataViewsColumnsList[i].dataViewDisplayName == '' || this.dataViews.dataViewsColumnsList[i].dataViewDisplayName == null || this.dataViews.dataViewsColumnsList[i].dataViewDisplayName == undefined) {
                        if (!this.dataViews.dataViewsColumnsList[i].formula) {
                            this.hideSaveButton = false;
                            this.notificationsService.error(
                                'Warning!',
                                'Build Expression for newly added row'
                            )
                            this.viewValidation = false;
                            this.dataViewsPost = [];
                            delete this.dataViews.dataViewsColumnsList;
                            delete this.dataViews.conditions;
                            delete this.dataViews.basedTemplate;
                            delete this.dataViews.viewRelation;
                        }
                    } else {
                        this.viewValidation = true;
                    }
                }

                if (count > 1) {
                    //   console.log('in amount >1 : ' + count);
                    this.hideSaveButton = false;
                    this.notificationsService.error(
                        'Warning!',
                        '"Amount" qualifier should be tagged only to one column with data type "DECIMAL"'
                    )
                    this.viewValidation = false;
                    this.dataViewsPost = [];
                    delete this.dataViews.dataViewsColumnsList;
                    delete this.dataViews.conditions;
                    delete this.dataViews.basedTemplate;
                    delete this.dataViews.viewRelation;
                } else if (count == 1) {
                    //   console.log('in amount=1 : ' + count);
                    if (intcount == 1) {
                        this.viewValidation = true;
                    } else {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Data type of "Amount" qualifier should be of type "DECIMAL"'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;
                    }
                } else if (count < 1) {
                    //  console.log('in amount<1 :' + count);
                    this.hideSaveButton = false;
                    this.notificationsService.error(
                        'Warning!',
                        '"Amount" qualifier is mandatory'
                    )
                    this.viewValidation = false;
                    this.dataViewsPost = [];
                    delete this.dataViews.dataViewsColumnsList;
                    delete this.dataViews.conditions;
                    delete this.dataViews.basedTemplate;
                    delete this.dataViews.viewRelation;
                }

                if (datecountint > 0 && datecount < 1) {
                    this.hideSaveButton = false;
                    this.viewValidation = false;
                    this.notificationsService.error(
                        'Warning!',
                        '"TRANSDATE" qualifier should be tagged to data type "DATE"'
                    )
                }
                if (datecountint1 > 0 && datecount1 < 1) {
                    this.hideSaveButton = false;
                    this.viewValidation = false;
                    this.notificationsService.error(
                        'Warning!',
                        '"TRANSDATE" qualifier should be tagged to data type"DATETIME"'
                    )
                }

                if (currcount > 1) {
                    this.hideSaveButton = false;
                    //   console.log('in currcount >1 : ' + currcount);
                    this.notificationsService.error(
                        'Warning!',
                        '"CURRENCY" qualifier should be tagged only to one column with data type "VARCHAR'
                    )
                    this.viewValidation = false;
                    this.dataViewsPost = [];
                    delete this.dataViews.dataViewsColumnsList;
                    delete this.dataViews.conditions;
                    delete this.dataViews.basedTemplate;
                    delete this.dataViews.viewRelation;
                } else if (currcount == 1) {
                    //   console.log('in currcount=1 : ' + currcount);
                    if (currcountint == 1) {
                    } else {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Data type of "CURRENCY" qualifier should be "VARCHAR"'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;
                    }
                }
                if (groupcount > 1) {
                    this.hideSaveButton = false;
                    //   console.log('in currcount >1 : ' + currcount);
                    this.notificationsService.error(
                        'Warning!',
                        '"GROUPBY_COLUMN" qualifier should be tagged only to one column with data type "VARCHAR'
                    )
                    this.viewValidation = false;
                    this.dataViewsPost = [];
                    delete this.dataViews.dataViewsColumnsList;
                    delete this.dataViews.conditions;
                    delete this.dataViews.basedTemplate;
                    delete this.dataViews.viewRelation;
                } else if (groupcount == 1) {
                    //   console.log('in currcount=1 : ' + currcount);
                    if (groupcountint == 1) {
                    } else {
                        this.hideSaveButton = false;
                        this.notificationsService.error(
                            'Warning!',
                            'Data type of "GROUPBY_COLUMN" qualifier should be "VARCHAR"'
                        )
                        this.viewValidation = false;
                        this.dataViewsPost = [];
                        delete this.dataViews.dataViewsColumnsList;
                        delete this.dataViews.conditions;
                        delete this.dataViews.basedTemplate;
                        delete this.dataViews.viewRelation;
                    }
                }
                if (groupByCount == 0) {
                    this.notificationsService.error(
                        'Warning!',
                        'Atleast one "Group By" column should be selected'
                    )
                    this.hideSaveButton = false;
                    this.viewValidation = false;
                }

            }
        } else {
            this.hideSaveButton = false;
            this.notificationsService.error(
                'Warning!',
                'Atleast one column is required from selected templates'
            )
            this.viewValidation = false;
            this.dataViewsPost = [];
            delete this.dataViews.dataViewsColumnsList;
            delete this.dataViews.conditions;
            delete this.dataViews.basedTemplate;
            delete this.dataViews.viewRelation;
        }



    }



    /**Block Special Characters and space*/
    blockSpecialChar(e, prevent) {
        var k = (e.which) ? e.which : e.keyCode;
        if (prevent == 'specialChar') {
            return ((k > 64 && k < 91) || (k > 96 && k < 123) || k == 8 || (k >= 48 && k <= 57) || (k == 32) || (k == 95));
        } else if (prevent == 'space') {
            return (k > 32);
        }
    }

}
