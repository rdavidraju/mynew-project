package com.nspl.app.web.rest;

import com.codahale.metrics.annotation.Timed;
import com.dropbox.core.DbxDownloader;
import com.dropbox.core.DbxException;
import com.dropbox.core.DbxRequestConfig;
import com.dropbox.core.v2.DbxClientV2;
import com.dropbox.core.v2.files.FileMetadata;
import com.dropbox.core.v2.files.Metadata;
import com.dropbox.core.v2.users.FullAccount;

import java.io.InputStream;

import com.jcraft.jsch.Channel;
import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;
import com.mysql.jdbc.Blob;
import com.nspl.app.domain.BatchHeader;
import com.nspl.app.domain.DataViews;
import com.nspl.app.domain.FileTemplateLines;
import com.nspl.app.domain.FileTemplates;
//import com.nspl.app.domain.FormConfig;
import com.nspl.app.domain.IntermediateTable;
import com.nspl.app.domain.LookUpCode;
import com.nspl.app.domain.RuleGroup;
import com.nspl.app.domain.RuleGroupDetails;
import com.nspl.app.domain.Rules;
import com.nspl.app.domain.SourceFileInbHistory;
import com.nspl.app.domain.SourceProfileFileAssignments;
import com.nspl.app.domain.SourceProfiles;
import com.nspl.app.domain.TenantConfig;
import com.nspl.app.repository.BatchHeaderRepository;
import com.nspl.app.repository.FileTemplateLinesRepository;
import com.nspl.app.repository.FileTemplatesRepository;
//import com.nspl.app.repository.FormConfigRepository;
import com.nspl.app.repository.IntermediateTableRepository;
import com.nspl.app.repository.LookUpCodeRepository;
import com.nspl.app.repository.RuleGroupDetailsRepository;
import com.nspl.app.repository.RuleGroupRepository;
import com.nspl.app.repository.RulesRepository;
import com.nspl.app.repository.SourceFileInbHistoryRepository;
import com.nspl.app.repository.SourceProfileFileAssignmentsRepository;
import com.nspl.app.repository.SourceProfilesRepository;
import com.nspl.app.repository.TenantConfigRepository;
import com.nspl.app.repository.search.FileTemplateLinesSearchRepository;
import com.nspl.app.repository.search.FileTemplatesSearchRepository;
import com.nspl.app.security.IDORUtils;
import com.nspl.app.service.FileTemplatesService;
import com.nspl.app.service.FindDelimiterAndFileExtensionService;
import com.nspl.app.service.UserJdbcService;
import com.nspl.app.web.rest.dto.ErrorReport;
import com.nspl.app.web.rest.dto.FileTempDTO;
import com.nspl.app.web.rest.dto.FileTemplateDTO;
import com.nspl.app.web.rest.dto.FileTemplateDataDTO;
import com.nspl.app.web.rest.dto.FileTemplateLinesDTO;
//import com.nspl.app.web.rest.dto.FileTemplatesInputDTO;
import com.nspl.app.web.rest.dto.FileTemplatesPostingDTO;
import com.nspl.app.web.rest.dto.FileTmpDTO;
import com.nspl.app.web.rest.dto.MultipleIdentifiersDTO;
import com.nspl.app.web.rest.dto.SampleDataDTO;
import com.nspl.app.web.rest.dto.SourceProfileFileAssignmentDTO;
import com.nspl.app.web.rest.dto.StatusStringDTO;
import com.nspl.app.web.rest.util.HeaderUtil;
import com.nspl.app.web.rest.util.PaginationUtil;

import io.swagger.annotations.ApiParam;
import io.github.jhipster.web.util.ResponseUtil;

import org.json.JSONException;
//import org.json.JSONObject;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cloud.cloudfoundry.com.fasterxml.jackson.core.JsonParser;
import org.springframework.cloud.cloudfoundry.com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.cloud.cloudfoundry.com.fasterxml.jackson.databind.type.TypeFactory;
import org.springframework.core.env.Environment;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.net.URI;
import java.net.URISyntaxException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.Vector;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.inject.Inject;
import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.servlet.http.HttpServletRequest;

import static org.elasticsearch.index.query.QueryBuilders.*;


/**
 * REST controller for managing FileTemplates.
 */
@RestController
@RequestMapping("/api")

public class FileTemplatesResource {

	private final Logger log = LoggerFactory.getLogger(FileTemplatesResource.class);

	private static final String ENTITY_NAME = "fileTemplates";

	private final FileTemplatesRepository fileTemplatesRepository;

	private final FileTemplatesSearchRepository fileTemplatesSearchRepository;

	private final SourceProfileFileAssignmentsRepository sourceProfileFileAssignmentsRepository;

	private final SourceProfilesRepository sourceProfilesRepository;

	private final FileTemplateLinesRepository fileTemplateLinesRepository;

	private final FindDelimiterAndFileExtensionService findDelimiterAndFileExtensionService;

	@Inject
	JobDetailsResource jobDetailsResource;

	@Inject
	FileTemplatesService fileTemplatesService;

	@Inject
	BatchHeaderRepository batchHeaderRepository;

	@Inject
	SourceFileInbHistoryRepository sourceFileInbHistoryRepository;

//	@Inject
//	FormConfigRepository formConfigRepository;

	public List<HashMap<String, String>> multipleIdentifiersList;

	@Inject
	RuleGroupRepository ruleGroupRepository;

	@Inject
	RuleGroupDetailsRepository ruleGroupDetailsRepository;

	@Inject
	RulesRepository rulesRepository;

	@Inject
	UserJdbcService userJdbcService;

	@Inject
	LookUpCodeRepository lookUpCodeRepository;

	@Inject
	IntermediateTableRepository intermediateTableRepository;

	@PersistenceContext(unitName="default")
	private EntityManager em;

	@Inject
	FileTemplateLinesSearchRepository fileTemplateLinesSearchRepository;

	@Inject
	private Environment env;
	
	@Inject
	TenantConfigRepository tenantConfigRepository;


	//declaration for img paths
	private String chaseImg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAk1BMVEX///8AXLnw8PEAWLcYZrQAYMIAXr1ahbFOfaxKi818q9vt7u5bibhLfrEXaLoib73Y29/29vcsdsDR194accne4eS4w89ChMcNacXn6es5drjBzdoXbMJmndUAZcuktMVljLSctMw2fMOSrMd6nL9xn81UldYfbr0JZ8RJf7aYveOFnrxnlME/fbwKYLamwNuFs+KsN3Y0AAABXElEQVRIie3W23KCMBAG4ATctB4QAyIirQdapUht+/5P14gKG7JBOtObzvS/5f8gM4ENjLUjjyOco1HAGUvGSnC1TKS9H50SxibAtYBnFUnw4ZiAQ2ER4wwGFOAQO1TfyUDQgEOWmH0ZA7cBSshC9ayAQxAR/Q7AwZ9p4NLqABzy0Oh3Ai7mjXi/djqBEmmrfwPClrdF1d/Xt6zAdjqwJj8/o2yWUAHp2DNW1z9droN7Gf0+KAuvzmTWA3hraHLoAR7QxrjDf/BXwZeLvpA+IFpNm6x6ADUiUYi+Ce5FA88/A7BSa4geO7KVGEBQjdgN/kBaecIA/OuAXSwFpyN8BERej9fUJjDAo5Klc1ogoPUZC2nRALFMmZYwp0QNbmMVZeYTU7sGZl/tR2CKG1hvqB0lxBXAjn4HkqwtLmD9QvfVexsDAbxXW18d7if9x8Q9g9DeV6fJfohzSI3GNxONHJoVvN79AAAAAElFTkSuQmCC";

	private String bOAImg="data:image/png;base64,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";

	private String wellsforgoImg="http://www.montrosechamber.org/wp-content/sabai/File/files/664e01a80cd59928f6152513282a9f9c.png";

	private String citiImg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAP1BMVEX///8AAJkzM8ymyvBmZsz/AACZmcwAAMzMzP//MzP/mZn/Zmb/zMwAM8z/fID/UFDx8fH/mczM7P/j4+Pq6urRYjM3AAAAuklEQVQ4jeWRSQKDIAxFMxFQtHa6/1mbQNUWtd23WTD9l08IAD8Zw9SFELp8OR/IrnaFGXb03s77ujKm3+inELLPwnVzaoGcSxKhFpM8HdRJyO1REiJxb0nAEpFEfbPogh6RIZo52QqRICG+6KRKKMWcdURRNiDO/rEWpfPtdVwBxfG9vBYQlG8AfQZ4LXcfsMeVO+QQUHu5eHsWgJTgugJgPbCgBOMzt2kUwI2l/CDrvWZ4Y3TzI/8cDzOPBHXjaCmjAAAAAElFTkSuQmCC";

	private String googleDriveImg="https://upload.wikimedia.org/wikipedia/commons/9/9b/Logo_of_Google_Drive.png";

	private String dropBoxImg="https://cfl.dropboxstatic.com/static/images/brand/twitter-card-glyph@2x-vflVqhKLO.png";

	private String sFTPImg="https://static1.squarespace.com/static/5410eb95e4b015076b7107ef/t/547e7ce3e4b08db18187a6cb/1417575651995/odrive-attachestoSFTP.png";




	public FileTemplatesResource(FileTemplatesRepository fileTemplatesRepository, FileTemplatesSearchRepository fileTemplatesSearchRepository,SourceProfileFileAssignmentsRepository sourceProfileFileAssignmentsRepository,SourceProfilesRepository sourceProfilesRepository,FileTemplateLinesRepository fileTemplateLinesRepository,FindDelimiterAndFileExtensionService findDelimiterAndFileExtensionService) {
		this.fileTemplatesRepository = fileTemplatesRepository;
		this.fileTemplatesSearchRepository = fileTemplatesSearchRepository;
		this.sourceProfileFileAssignmentsRepository=sourceProfileFileAssignmentsRepository;
		this.sourceProfilesRepository=sourceProfilesRepository;
		this.fileTemplateLinesRepository=fileTemplateLinesRepository;
		this.findDelimiterAndFileExtensionService=findDelimiterAndFileExtensionService;
	}
	/**
	 * POST  /file-templates : Create a new fileTemplates.
	 *
	 * @param fileTemplates the fileTemplates to create
	 * @return the ResponseEntity with status 201 (Created) and with body the new fileTemplates, or with status 400 (Bad Request) if the fileTemplates has already an ID
	 * @throws URISyntaxException if the Location URI syntax is incorrect
	 */
	@PostMapping("/file-templates/{userId}")
	@Timed
	public ResponseEntity<FileTemplates> createFileTemplates(HttpServletRequest request,@RequestBody FileTemplates fileTemplates)throws URISyntaxException {
		//			,@RequestParam Long userId) throws URISyntaxException {
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long userId=Long.parseLong(map.get("userId").toString());
		log.debug("REST request to save FileTemplates for user:"+userId+" -> ", fileTemplates);

		if (fileTemplates.getId() != null) {
			return ResponseEntity.badRequest().headers(HeaderUtil.createFailureAlert(ENTITY_NAME, "idexists", "A new fileTemplates cannot already have an ID")).body(null);
		}
		fileTemplates.setLastUpdatedDate(ZonedDateTime.now());
		fileTemplates.setCreatedDate(ZonedDateTime.now());
		fileTemplates.setCreatedBy(userId);
		fileTemplates.setLastUpdatedBy(userId);
		FileTemplates result = fileTemplatesRepository.save(fileTemplates);
		
		String idForDisplay = IDORUtils.computeFrontEndIdentifier(result.getId().toString());
		result.setIdForDisplay(idForDisplay);
		result = fileTemplatesRepository.save(result);
		
		fileTemplatesSearchRepository.save(result);
		return ResponseEntity.created(new URI("/api/file-templates/" + result.getId()))
				.headers(HeaderUtil.createEntityCreationAlert(ENTITY_NAME, result.getId().toString()))
				.body(result);
	}

	/**
	 * PUT  /file-templates : Updates an existing fileTemplates.
	 *
	 * @param fileTemplates the fileTemplates to update
	 * @return the ResponseEntity with status 200 (OK) and with body the updated fileTemplates,
	 * or with status 400 (Bad Request) if the fileTemplates is not valid,
	 * or with status 500 (Internal Server Error) if the fileTemplates couldnt be updated
	 * @throws URISyntaxException if the Location URI syntax is incorrect
	 */
	@PutMapping("/file-templates")
	@Timed
	public ResponseEntity<FileTemplates> updateFileTemplates(HttpServletRequest request,@RequestBody FileTemplates fileTemplates)throws URISyntaxException {
		//			,@RequestParam Long userId) throws URISyntaxException {
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long userId=Long.parseLong(map.get("userId").toString());
		log.debug("REST request to update FileTemplates for user:"+userId+" -> ", fileTemplates);


		if (fileTemplates.getId() == null) {
			return createFileTemplates(request,fileTemplates);
		}
		fileTemplates.setLastUpdatedDate(ZonedDateTime.now());
		fileTemplates.setCreatedBy(userId);
		fileTemplates.setLastUpdatedBy(userId);
		FileTemplates result = fileTemplatesRepository.save(fileTemplates);
		fileTemplatesSearchRepository.save(result);
		return ResponseEntity.ok()
				.headers(HeaderUtil.createEntityUpdateAlert(ENTITY_NAME, fileTemplates.getId().toString()))
				.body(result);
	}


	@GetMapping("/_search/file-templates")
	@Timed
	public ResponseEntity<List<FileTemplates>> searchFileTemplates(HttpServletRequest request,@RequestParam(value="filterValue",required=false) String filterValue,
			@RequestParam(value = "page" , required = false) Integer offset,
			@RequestParam(value = "per_page", required = false) Integer limit) {
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());


		log.info("Rest api for fetching file templates data from elasticsearch repository for the tenant_id: "+tenantId);
		String query = "";
		query = query + " tenantId: \""+tenantId+"\" ";		// Filtering with tenant id	
		if(filterValue != null)
		{
			query = query + " AND \""+filterValue+"\"";
		} 
		log.info("query"+query);
		log.info("offset:"+offset+"limit"+limit);
		Page<FileTemplates> page = fileTemplatesSearchRepository.search(queryStringQuery(query),PaginationUtil.generatePageRequest(offset, limit));
		HttpHeaders headers = PaginationUtil.generateSearchPaginationHttpHeaders(query, page, "/api/_search/file-templates");
		return new ResponseEntity<>(page.getContent(), headers, HttpStatus.OK);
	}

	/**
	 * GET  /file-templates/:id : get the "id" fileTemplates.
	 *
	 * @param id the id of the fileTemplates to retrieve
	 * @return the ResponseEntity with status 200 (OK) and with body the fileTemplates, or with status 404 (Not Found)
	 */
	@GetMapping("/file-templates/{idForDisplay}")
	@Timed
	public ResponseEntity<FileTempDTO> getFileTemplates(HttpServletRequest request, @PathVariable String idForDisplay) {
		log.debug("REST request to get FileTemplates : {}", idForDisplay);
		
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());
		
		FileTemplates fileTemplates = fileTemplatesRepository.findByIdForDisplayAndTenantId(idForDisplay,tenantId);
		FileTempDTO fileTempDTO = new FileTempDTO();
		if(fileTemplates.getCreatedBy() != null)
		fileTempDTO.setCreatedBy(fileTemplates.getCreatedBy());
		fileTempDTO.setDelimiter(fileTemplates.getDelimiter());
		fileTempDTO.setDescription(fileTemplates.getDescription());
		fileTempDTO.setEndDate(fileTemplates.getEndDate());
		fileTempDTO.setFileType(fileTemplates.getFileType());
		fileTempDTO.setHeaderRowNumber(fileTemplates.getHeaderRowNumber());
		fileTempDTO.setId(idForDisplay);
		fileTempDTO.setLastUpdatedBy(fileTemplates.getLastUpdatedBy());
		fileTempDTO.setNumberOfColumns(fileTemplates.getNumber_of_columns());
		/*if(fileTemplates.getData() != null && !fileTemplates.getData().isEmpty() && !fileTemplates.getData().equals(""))
		{
			SampleDataDTO sampleDataDTO  =  new SampleDataDTO();
			sampleDataDTO = findDelimiterAndFileExtensionService.displayingBlobData(fileTemplates.getData());
			fileTempDTO.setData(fileTemplates.getData());
			fileTempDTO.setColHeaders(sampleDataDTO.getColHeaders());
		}*/
		JSONParser parser = new JSONParser();
		JSONArray newJObject = null;
		try {
			newJObject = (JSONArray) parser.parse(fileTemplates.getData());
			fileTempDTO.setSampleData(newJObject);
		} catch (ParseException e) {
			e.printStackTrace();
		}
		fileTempDTO.setSdFilename(fileTemplates.getSdFilename());
		fileTempDTO.setSkipRowsEnd(fileTemplates.getSkipRowsEnd());
		fileTempDTO.setSkipRowsStart(fileTemplates.getSkipRowsStart());
		fileTempDTO.setSource(fileTemplates.getSource());
		fileTempDTO.setStartDate(fileTemplates.getStartDate());
		fileTempDTO.setStatus(fileTemplates.getStatus());
		fileTempDTO.setTemplateName(fileTemplates.getTemplateName());
		fileTempDTO.setTenantId(fileTemplates.getTenantId());
		fileTempDTO.setRowIdentifier(fileTemplates.getRowIdentifier());
		fileTempDTO.setMultipleRowIdentifiers(fileTemplates.getMultipleIdentifier());

		return ResponseUtil.wrapOrNotFound(Optional.ofNullable(fileTempDTO));
	}

	/**
	 * DELETE  /file-templates/:id : delete the "id" fileTemplates.
	 *
	 * @param id the id of the fileTemplates to delete
	 * @return the ResponseEntity with status 200 (OK)
	 */
	@DeleteMapping("/file-templates/{id}")
	@Timed
	public ResponseEntity<Void> deleteFileTemplates(@PathVariable Long id) {
		log.debug("REST request to delete FileTemplates : {}", id);
		fileTemplatesRepository.delete(id);
		fileTemplatesSearchRepository.delete(id);
		return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(ENTITY_NAME, id.toString())).build();
	}

	/**
	 * SEARCH  /_search/file-templates?query=:query : search for the fileTemplates corresponding
	 * to the query.
	 *
	 * @param query the query of the fileTemplates search 
	 * @param pageable the pagination information
	 * @return the result of the search
	 */
	/*	@GetMapping("/_search/file-templates")
	@Timed
	public ResponseEntity<List<FileTemplates>> searchFileTemplates(@RequestParam String query, @ApiParam Pageable pageable) {
		log.debug("REST request to search for a page of FileTemplates for query {}", query);
		Page<FileTemplates> page = fileTemplatesSearchRepository.search(queryStringQuery(query), pageable);
		HttpHeaders headers = PaginationUtil.generateSearchPaginationHttpHeaders(query, page, "/api/_search/file-templates");
		return new ResponseEntity<>(page.getContent(), headers, HttpStatus.OK);
	}*/
	/**
	 * Author : Shobha
	 * @param file
	 * @return
	 * @throws IOException 
	 */
	@PostMapping("/fileUpload")
	@Timed
	public StatusStringDTO fileUpload(@RequestParam MultipartFile file) throws IOException
	{
		log.debug("Rest request for file upload");
		StatusStringDTO statusDTo = new StatusStringDTO();

		try {
			InputStream is = file.getInputStream();
			OutputStream os = new FileOutputStream("/home/nspl/Files/sample.csv");
			byte[] buffer = new byte[1024];
			int bytesRead;
			//read from is to buffer
			while((bytesRead = is.read(buffer)) !=-1){
				os.write(buffer, 0, bytesRead);
			}
			is.close();
			//flush OutputStream to write any buffered data to file
			os.flush();
			os.close();
		} catch (FileNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		/*if(file.getOriginalFilename() != null)
			statusDTo.setStatus("success");
		else
			statusDTo.setStatus("failure");*/
		return statusDTo;
	}
	/**
	 * Author : Shobha
	 * @param file
	 * @return
	 */
	@PostMapping("/multipleFileUpload")
	@Timed
	public StatusStringDTO multipleFileUpload(@RequestParam List<MultipartFile> file)
	{
		log.debug("Rest request to file upload"+file.size());
		log.info("file name is:"+file.get(0).getOriginalFilename());
		StatusStringDTO statusDTo = new StatusStringDTO();
		if(file.get(0).getOriginalFilename() != null)
			statusDTo.setStatus("success");
		else
			statusDTo.setStatus("failure");
		return statusDTo;
	}



	/**
	 * Auhtor:Ravali
	 *@param templateId
	 * @return sourceAssignmnetProfile and sourceProfile(DTO)
	 */
	@GetMapping("/getSourceProfileAssigAndSourceProfile")
	@Timed
	public List<FileTemplateDTO> fetchfileTemplateDTO(@RequestParam Long templateId)
	{
		List<FileTemplateDTO> fileTemplateDtoList=new ArrayList<FileTemplateDTO>();

		List<SourceProfileFileAssignments> sourceProfileAssignments = new ArrayList<SourceProfileFileAssignments>();
		sourceProfileAssignments = sourceProfileFileAssignmentsRepository.findByTemplateId(templateId);
		for(int i=0;i<sourceProfileAssignments.size();i++)
		{

			FileTemplateDTO fileTemplateDto=new FileTemplateDTO();
			fileTemplateDto.setSPAId(sourceProfileAssignments.get(i).getId());
			if(sourceProfileAssignments.get(i).getSourceProfileId()!=null)
				fileTemplateDto.setSourceProfileId(sourceProfileAssignments.get(i).getSourceProfileId());
			if(sourceProfileAssignments.get(i).getFileNameFormat()!=null&&!sourceProfileAssignments.get(i).getFileNameFormat().isEmpty())
				fileTemplateDto.setFileNameFormat(sourceProfileAssignments.get(i).getFileNameFormat());
			if(sourceProfileAssignments.get(i).getFileDescription()!=null&&!sourceProfileAssignments.get(i).getFileDescription().isEmpty())
				fileTemplateDto.setFileDescription(sourceProfileAssignments.get(i).getFileDescription());
			if(sourceProfileAssignments.get(i).getFileExtension()!=null&&!sourceProfileAssignments.get(i).getFileExtension().isEmpty())
				fileTemplateDto.setFileExtension(sourceProfileAssignments.get(i).getFileExtension());
			if(sourceProfileAssignments.get(i).getFrequencyType()!=null&&!sourceProfileAssignments.get(i).getFrequencyType().isEmpty())
				fileTemplateDto.setFrequencyType(sourceProfileAssignments.get(i).getFrequencyType());
			if(sourceProfileAssignments.get(i).getDueTime()!=null&&!sourceProfileAssignments.get(i).getDueTime().isEmpty())
				fileTemplateDto.setDueTime(sourceProfileAssignments.get(i).getDueTime());
			if(sourceProfileAssignments.get(i).getDay()!=null)
				fileTemplateDto.setDay(sourceProfileAssignments.get(i).getDay());
			if(sourceProfileAssignments.get(i).getSourceDirectoryPath()!=null&&!sourceProfileAssignments.get(i).getSourceDirectoryPath().isEmpty())
				fileTemplateDto.setSourceDirectoryPath(sourceProfileAssignments.get(i).getSourceDirectoryPath());
			if(sourceProfileAssignments.get(i).getLocalDirectoryPath()!=null&&!sourceProfileAssignments.get(i).getLocalDirectoryPath().isEmpty())
				fileTemplateDto.setLocalDirectoryPath(sourceProfileAssignments.get(i).getLocalDirectoryPath());
			if(sourceProfileAssignments.get(i).getTemplateId()!=null)
				fileTemplateDto.setTemplateId(sourceProfileAssignments.get(i).getTemplateId());
			if(sourceProfileAssignments.get(i).isEnabledFlag()!=null)
				fileTemplateDto.setSPAEnabledFlag(sourceProfileAssignments.get(i).isEnabledFlag());
			if(sourceProfileAssignments.get(i).getCreatedBy()!=null)
				fileTemplateDto.setSPACreatedBy(sourceProfileAssignments.get(i).getCreatedBy());
			if(sourceProfileAssignments.get(i).getCreatedDate()!=null)
				fileTemplateDto.setSPACreationDate(sourceProfileAssignments.get(i).getCreatedDate());
			if(sourceProfileAssignments.get(i).getLastUpdatedBy()!=null)
				fileTemplateDto.setSPALastUpdatedBy(sourceProfileAssignments.get(i).getLastUpdatedBy());
			if(sourceProfileAssignments.get(i).getLastUpdatedDate()!=null)
				fileTemplateDto.setSPALastUpdatedDate(sourceProfileAssignments.get(i).getLastUpdatedDate());


			if(sourceProfileAssignments.get(i).getSourceProfileId()!=null)
			{
				SourceProfiles sourceProfiles=sourceProfilesRepository.findOne(sourceProfileAssignments.get(i).getSourceProfileId());

				if(sourceProfiles.getSourceProfileName()!=null&&!sourceProfiles.getSourceProfileName().isEmpty())
					fileTemplateDto.setSourceProfileName(sourceProfiles.getSourceProfileName());
				if(sourceProfiles.getDescription()!=null&&!sourceProfiles.getDescription().isEmpty())
					fileTemplateDto.setDescription(sourceProfiles.getDescription());
				if(sourceProfiles.getStartDate()!=null)
					fileTemplateDto.setStartDate(sourceProfiles.getStartDate());
				if(sourceProfiles.getEndDate()!=null)
					fileTemplateDto.setEndDate(sourceProfiles.getEndDate());
				if(sourceProfiles.isEnabledFlag()!=null)
					fileTemplateDto.setSourceProfileEnableFlag(sourceProfiles.isEnabledFlag());
				if(sourceProfiles.getConnectionId()!=null)
					fileTemplateDto.setConnectionId(sourceProfiles.getConnectionId());
				if(sourceProfiles.getTenantId()!=null)
					fileTemplateDto.setTenantId(sourceProfiles.getTenantId());
				if(sourceProfiles.getCreatedBy()!=null)
					fileTemplateDto.setSourceProfileCreatedBy(sourceProfiles.getCreatedBy());
				if(sourceProfiles.getCreatedDate()!=null)
					fileTemplateDto.setSourceProfileCreationDate(sourceProfiles.getCreatedDate());
				if(sourceProfiles.getLastUpdatedBy()!=null)
					fileTemplateDto.setSourceProfileLastUpdatedBy(sourceProfiles.getLastUpdatedBy());
				if(sourceProfiles.getLastUpdatedDate()!=null)
					fileTemplateDto.setSourceProfileLastUpdateDate(sourceProfiles.getLastUpdatedDate());
			}
			fileTemplateDtoList.add(fileTemplateDto);

		}
		return fileTemplateDtoList;

	}


	/**
	 * Auhtor:Ravali
	 *@param FileTemplatesPostingDTO
	 * @return ErrorReport
	 */
	@PostMapping("/FileTemplatesPostingDTO")
	@Timed
	public List<ErrorReport> postingFileTempAndFileTempLinesAndSPA(@RequestBody FileTemplatesPostingDTO fileTemplatesPostingDTO, HttpServletRequest request)
	{
		//	User currentUser=userService.getCurrentUser();
		//	Long tenantId=currentUser.getTenantId();
		List<ErrorReport> finalErrorReport=new ArrayList<ErrorReport>();
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());
		Long userId=Long.parseLong(map.get("userId").toString());
		FileTemplates filetempRecord=new FileTemplates();
		log.info("Rest Request to post File template , File Template Lines and source profile assignments for tenant: "+tenantId);
		String save="Failure";
		int count=0;
		if(fileTemplatesPostingDTO!=null)
		{
			//save FileTemplates
			FileTemplates fileTemplate=new FileTemplates();
			FileTempDTO fileTempDTO=fileTemplatesPostingDTO.getFileTempDTO();
			HashMap<String,Long> interRecordToIdMap = new HashMap<String,Long>();
			if(fileTemplatesPostingDTO.getFileTempDTO()!=null)
			{
				//log.info("fileTemplatesPostingDTO.getFileTempDTO(): "+fileTemplatesPostingDTO.getFileTempDTO());

				if(fileTempDTO.getId()!=null)
				{
					
					FileTemplates ft= fileTemplatesRepository.findByIdForDisplayAndTenantId(fileTempDTO.getId(), tenantId);
					fileTemplate.setId(ft.getId());
					if(userId != null)
						fileTemplate.setCreatedBy(userId);
				}
				if(userId != null)
					fileTemplate.setLastUpdatedBy(userId);
				if(fileTempDTO.getTemplateName()!=null&&!fileTempDTO.getTemplateName().isEmpty())
					fileTemplate.setTemplateName(fileTempDTO.getTemplateName());
				if(fileTempDTO.getDescription()!=null&&!fileTempDTO.getDescription().isEmpty())
					fileTemplate.setDescription(fileTempDTO.getDescription());
				if(fileTempDTO.getStartDate()!=null)
					fileTemplate.setStartDate(fileTempDTO.getStartDate());
				if(fileTempDTO.getEndDate()!=null)
					fileTemplate.setEndDate(fileTempDTO.getEndDate());
				fileTemplate.setMultipleIdentifier(fileTempDTO.getMultipleRowIdentifiers());
				if(fileTempDTO.getStatus()!=null&&!fileTempDTO.getStatus().isEmpty())
					fileTemplate.setStatus(fileTempDTO.getStatus());
				else
					fileTemplate.setStatus("Active");
				if(fileTempDTO.getFileType()!=null&&!fileTempDTO.getFileType().isEmpty())
					fileTemplate.setFileType(fileTempDTO.getFileType());
				if(fileTempDTO.getFileType()!=null&&!fileTempDTO.getFileType().isEmpty())
					fileTemplate.setDelimiter(fileTempDTO.getDelimiter());
				if(fileTempDTO.getSource()!=null&&!fileTempDTO.getSource().isEmpty())
					fileTemplate.setSource(fileTempDTO.getSource());
				if(fileTempDTO.getSkipRowsStart()!=null)
					fileTemplate.setSkipRowsStart(fileTempDTO.getSkipRowsStart());
				if(fileTempDTO.getSkipRowsEnd()!=null)
					fileTemplate.setSkipRowsEnd(fileTempDTO.getSkipRowsEnd());
				if(fileTempDTO.getNumberOfColumns()!=null)
					fileTemplate.setNumber_of_columns(fileTempDTO.getNumberOfColumns());
				if(fileTempDTO.getHeaderRowNumber()!=null)
					fileTemplate.setHeaderRowNumber(fileTempDTO.getHeaderRowNumber());
				if(fileTempDTO.getRowIdentifier()!=null)
					System.out.println("fileTempDTO.getRowIdentifier(): "+fileTempDTO.getRowIdentifier());
				fileTemplate.setRowIdentifier(fileTempDTO.getRowIdentifier());
				fileTemplate.setData(fileTempDTO.getData());
				/*if(fileTempDTO.getSampleData().size() > 0)
				{
					String sampleDataConvToBlob = "";
					sampleDataConvToBlob = findDelimiterAndFileExtensionService.savingBlobData(fileTempDTO.getSampleData());
					if(sampleDataConvToBlob != null && !sampleDataConvToBlob.isEmpty() && !sampleDataConvToBlob.equals(""))
					{
						fileTemplate.setData(sampleDataConvToBlob);
					}
				}*/
				fileTemplate.setTenantId(tenantId);
				//	if(fileTempDTO.getTenantId()!=null)
				//fileTemplate.setTenantId(fileTempDTO.getTenantId());
				//if(fileTempDTO.getCreatedBy()!=null)
					//fileTemplate.setCreatedBy(fileTempDTO.getCreatedBy());
			//	if(fileTempDTO.getLastUpdatedBy()!=null)
					//fileTemplate.setLastUpdatedBy(fileTempDTO.getLastUpdatedBy());
				fileTemplate.setCreatedDate(ZonedDateTime.now());
				fileTemplate.setLastUpdatedDate(ZonedDateTime.now());
				//if(fileTemplate!=null)
				//By Kiran to set sample data filename
				if(fileTempDTO.getSdFilename()!=null)
					fileTemplate.setSdFilename(fileTempDTO.getSdFilename());
				filetempRecord=fileTemplatesRepository.save(fileTemplate);
				
				String idForDisplay = IDORUtils.computeFrontEndIdentifier(filetempRecord.getId().toString());
				filetempRecord.setIdForDisplay(idForDisplay);
				filetempRecord = fileTemplatesRepository.save(filetempRecord);
				
				fileTemplatesSearchRepository.save(filetempRecord);
				ErrorReport fileTempErrorReport=new ErrorReport();
				fileTempErrorReport.setTaskName("File Template Save");
				log.info("fileTemplate :"+fileTemplate);
				if(filetempRecord.getId()!=null)
				{
					count=1;
					fileTempErrorReport.setTaskStatus("Success");
					fileTempErrorReport.setDetails(filetempRecord.getIdForDisplay()+"");
					finalErrorReport.add(fileTempErrorReport);
				}
				else{
					fileTempErrorReport.setTaskStatus("Failure");
					finalErrorReport.add(fileTempErrorReport);
				}
				//save intermediate records

				if(filetempRecord != null && filetempRecord.getId() != null && fileTempDTO.getMultipleRowIdentifiers() == true)
				{
					List<MultipleIdentifiersDTO> multipleRIList = new ArrayList<MultipleIdentifiersDTO>();
					multipleRIList = fileTemplatesPostingDTO.getMultipleRIList();
					Long templateId = filetempRecord.getId() ;
					List<IntermediateTable> multipleIdentifiersForTemplate = new ArrayList<IntermediateTable>();
					for(MultipleIdentifiersDTO MRI : multipleRIList)
					{
						IntermediateTable rowIdentifierRecord = new IntermediateTable();
						if(fileTempDTO.getCreatedBy()!=null)
							rowIdentifierRecord.setCreatedBy(fileTempDTO.getCreatedBy());
						rowIdentifierRecord.setCreationDate(ZonedDateTime.now());
						/*if(MRI.getData().size() >0)
						{
							String sampleDataConvToBlob = "";
							sampleDataConvToBlob = findDelimiterAndFileExtensionService.savingBlobData(MRI.getData());
							if(sampleDataConvToBlob != null && !sampleDataConvToBlob.isEmpty() && !sampleDataConvToBlob.equals(""))
							{
								fileTemplate.setData(sampleDataConvToBlob);
							}
						}*/
						if(MRI.getId() != null)
							rowIdentifierRecord.setId(MRI.getId());
						rowIdentifierRecord.setData(MRI.getData());
						//rowIdentifierRecord.setHeaderInfo(headerInfo);
						rowIdentifierRecord.setLastUpdatedBy(fileTempDTO.getCreatedBy());
						rowIdentifierRecord.setLastUpdatedDate(ZonedDateTime.now());
						rowIdentifierRecord.setPositionEnd(MRI.getPositionEnd());
						rowIdentifierRecord.setPositionStart(MRI.getPositionStart());
						rowIdentifierRecord.setRowIdentifier(MRI.getRowIdentifier());
						rowIdentifierRecord.setRowIdentifierCriteria(MRI.getCriteria());
						//rowIdentifierRecord.setRowInfo(MRI.get);
						if(templateId != null)
							rowIdentifierRecord.setTemplateId(templateId);
						rowIdentifierRecord.setTenantId(tenantId);
						//if(fileTempDTO.getTenantId()!=null)
						//rowIdentifierRecord.setTenantId(fileTempDTO.getTenantId());
						multipleIdentifiersForTemplate.add(rowIdentifierRecord);
					}
					List<IntermediateTable> savedIdentifiers = intermediateTableRepository.save(multipleIdentifiersForTemplate);

					if(savedIdentifiers != null && savedIdentifiers.size()>0)
					{
						for(IntermediateTable ITR : savedIdentifiers){
							interRecordToIdMap.put(ITR.getRowIdentifier(), ITR.getId());
						}
					}
					log.info("interRecordToIdMap:"+interRecordToIdMap);
				}
			}
			if(filetempRecord.getId()!=null)
			{
				if(fileTemplatesPostingDTO.getFileTemplateLinesListDTO().size() > 0)
				{
					for(int j =0;j<fileTemplatesPostingDTO.getFileTemplateLinesListDTO().size();j++)
					{
						List<FileTemplateLinesDTO> FileTemplateLinesList=fileTemplatesPostingDTO.getFileTemplateLinesListDTO().get(j);
						if(FileTemplateLinesList.size()>0)
						{
							List<FileTemplateLines> fileTempLinesList=new ArrayList<FileTemplateLines>();
							String str="";
							ErrorReport fileTempLinesErrReport=new ErrorReport();

							for(int i=0;i<FileTemplateLinesList.size();i++)
							{
								FileTemplateLinesDTO fileTempLinesDTO=FileTemplateLinesList.get(i);
								//						log.info("fileTempLinesDTO printing1:"+fileTempLinesDTO.getRecordType());
								FileTemplateLines fileTempLines=new FileTemplateLines();
								if(fileTempLinesDTO.getColumnHeader() !=null&&!fileTempLinesDTO.getColumnHeader().isEmpty())
								{
									//log.info("fileTempLinesDTO.getColumnHeader()2:- "+fileTempLinesDTO.getColumnHeader());
									if(fileTempLinesDTO.getId()!=null)
									{
										fileTempLines.setId(fileTempLinesDTO.getId());
									}
									if(filetempRecord.getId()!=null)
										fileTempLines.setTemplateId(filetempRecord.getId());
									//link intermediate id
									if(fileTempDTO.getMultipleRowIdentifiers() == true)
									{
										log.info("yes its true");
										String MI = "";
										log.info("fileTempLinesDTO.getMI()"+fileTempLinesDTO.getInterRI());
										MI = fileTempLinesDTO.getInterRI();
										log.info("MI"+MI);

										if(interRecordToIdMap != null && interRecordToIdMap.containsKey(MI) && interRecordToIdMap.get(MI)!= null)
										{
											fileTempLines.setIntermediateId(interRecordToIdMap.get(MI));
										}
										else
										{
											log.info("interRecordToIdMap.get(MI) isnull");
										}
									}
									//System.out.println("fileTempLinesDTO.getLineNumber(): "+fileTempLinesDTO.getLineNumber());
									if(fileTempLinesDTO.getRecordStartRow()!=null)
										fileTempLines.setRecordStartRow(fileTempLinesDTO.getRecordStartRow());

									if(fileTempLinesDTO.getLineNumber()!=null)
										fileTempLines.setLineNumber(fileTempLinesDTO.getLineNumber());
									if(fileTempLinesDTO.getMasterTableReferenceColumn()!=null)
										fileTempLines.setMasterTableReferenceColumn(fileTempLinesDTO.getMasterTableReferenceColumn());
									if(fileTempLinesDTO.getRecordTYpe()!=null&&!fileTempLinesDTO.getRecordTYpe().isEmpty())
									{
										//log.info("fileTempLinesDTO printing2:"+fileTempLinesDTO.getRecordTYpe());
										fileTempLines.setRecordTYpe(fileTempLinesDTO.getRecordTYpe());
									}else
										fileTempLines.setRecordTYpe("Row Data");
									//log.info("fileTempLinesDTO printing3:"+fileTempLines.getRecordTYpe());

									log.info("fileTempLinesDTO.getRecordIdentifier(): "+fileTempLinesDTO.getRecordIdentifier()+" fileTempLinesDTO.getRecordStartRow(): "+fileTempLinesDTO.getRecordStartRow());

									if(fileTempLinesDTO.getRecordIdentifier()!=null)
									{
										fileTempLines.setRecordIdentifier(fileTempLinesDTO.getRecordIdentifier());
									}
									else{
										fileTempLines.setRecordIdentifier(fileTempLinesDTO.getRecordStartRow());}

									if(fileTempLinesDTO.getColumnNumber()!=null)
										fileTempLines.setColumnNumber(fileTempLinesDTO.getColumnNumber());

									if(fileTempLinesDTO.getRecordStartRow()!=null)
										//log.info("fileTempLinesDTO.getRecordStartRow(): "+fileTempLinesDTO.getRecordStartRow());
										//fileTempLines.setRecordStartRow(fileTempLinesDTO.getRecordStartRow());
										if(fileTempLinesDTO.getEnclosedChar()!=null&&!fileTempLinesDTO.getEnclosedChar().isEmpty())
											fileTempLines.setEnclosedChar(fileTempLinesDTO.getEnclosedChar());
									if(fileTempLinesDTO.getEnclosedChar()!=null&&!fileTempLinesDTO.getEnclosedChar().isEmpty())
										fileTempLines.setEnclosedChar(fileTempLinesDTO.getEnclosedChar());
									if(fileTempLinesDTO.getPositionBegin()!=null)
										fileTempLines.setPositionBegin(fileTempLinesDTO.getPositionBegin());
									if(fileTempLinesDTO.getPositionEnd()!=null)
										fileTempLines.setPositionEnd(fileTempLinesDTO.getPositionEnd());
									if(fileTempLinesDTO.getColumnHeader()!=null&&!fileTempLinesDTO.getColumnHeader().isEmpty())
										fileTempLines.setColumnHeader(fileTempLinesDTO.getColumnHeader());
									if(fileTempLinesDTO.getColumnHeader()!=null&&!fileTempLinesDTO.getColumnHeader().isEmpty())
										fileTempLines.setConstantValue(fileTempLinesDTO.getConstantValue());
									if(fileTempLinesDTO.getZeroFill()!=null&&!fileTempLinesDTO.getZeroFill().isEmpty())
										fileTempLines.setZeroFill(fileTempLinesDTO.getZeroFill());
									if(fileTempLinesDTO.getAlign()!=null&&!fileTempLinesDTO.getAlign().isEmpty())
										fileTempLines.setAlign(fileTempLinesDTO.getAlign());
									if(fileTempLinesDTO.getFormula()!=null&&!fileTempLinesDTO.getFormula().isEmpty())
										fileTempLines.setFormula(fileTempLinesDTO.getFormula());
									if(fileTempLinesDTO.getDateFormat()!=null&&!fileTempLinesDTO.getDateFormat().isEmpty())
										fileTempLines.setDateFormat(fileTempLinesDTO.getDateFormat());
									if(fileTempLinesDTO.getTimeFormat()!=null&&!fileTempLinesDTO.getTimeFormat().isEmpty())
										fileTempLines.setTimeFormat(fileTempLinesDTO.getTimeFormat());
									if(fileTempLinesDTO.getAmountFormat()!=null&&!fileTempLinesDTO.getAmountFormat().isEmpty())
										fileTempLines.setAmountFormat(fileTempLinesDTO.getAmountFormat());
									if(fileTempLinesDTO.getAmountFormat()!=null&&!fileTempLinesDTO.getAmountFormat().isEmpty())
										fileTempLines.setOverFlow(fileTempLinesDTO.getOverFlow());
									if(fileTempLinesDTO.getSkipColumn()!=null&&!fileTempLinesDTO.getSkipColumn().isEmpty())
										fileTempLines.setSkipColumn(fileTempLinesDTO.getSkipColumn());
									if(fileTempLinesDTO.getColumnDelimeter()!=null&&!fileTempLinesDTO.getColumnDelimeter().isEmpty())
										fileTempLines.setColumnDelimiter(fileTempLinesDTO.getColumnDelimeter());
									if(fileTempLinesDTO.getCreatedBy()!=null)
										fileTempLines.setCreatedBy(fileTempLinesDTO.getCreatedBy());

									fileTempLines.setCreatedDate(ZonedDateTime.now());
									if(fileTempLinesDTO.getLastUpdatedBy()!=null)
										fileTempLines.setLastUpdatedBy(fileTempLinesDTO.getCreatedBy());
									fileTempLines.setLastUpdatedDate(ZonedDateTime.now());



									//	if(fileTempLinesDTO.getColumnHeader().)
									// Swetha
									/* Logic to process column header and save it in column alias */
									//String s=fileTempLinesDTO.getColumnHeader();
									//String s="% Rate -???^&df_#S";
									String s=fileTempLinesDTO.getColumnHeader();
									Pattern pattern = Pattern.compile("[^a-z A-Z 0-9]");
									Matcher matcher = pattern.matcher(s);
									String number = matcher.replaceAll("");
									System.out.println("number: "+number);

									String finalCol="";
									String b[]=number.split("\\s+");
									for(int l=0;l<b.length;l++){
										System.out.println("b[l] at l: "+l+" is: "+b[l]);
										if(b[l]!=null && !(b[l].isEmpty())){
											String val1=Character.toString(b[l].charAt(0));
											String val2=Character.toString(Character.toTitleCase(b[l].charAt(0)));
											if(b[l].contains(val1)){
												System.out.println("contains");
												b[l]=b[l].replace(val1, val2);
											}
										}
										finalCol=finalCol.concat(b[l]);
									}

									log.info("finalCol: "+finalCol);
									fileTempLines.setColumnAlias(finalCol+"_"+filetempRecord.getId());


									FileTemplateLines fileTempLine=fileTemplateLinesRepository.save(fileTempLines);
									fileTemplateLinesSearchRepository.save(fileTempLine);
									fileTempLinesList.add(fileTempLine);
									//log.info("fileTempLinesDTO.line: :"+fileTempLinesDTO.getLineNumber());
									if(fileTempLine!=null&&fileTempLine.getId()!=null)
									{
										fileTempLinesErrReport.setTaskName("File Template Lines Save");
										fileTempLinesErrReport.setTaskStatus("Success");

									}
									else
									{
										fileTempLinesErrReport.setTaskName("File Template Lines Save");
										fileTempLinesErrReport.setTaskStatus("Failure");
										str=str+fileTempLinesDTO.getLineNumber()+",";
										//fileTempLinesErrReport.setDetails("Failed to save at line number :"+str);
									}
								}
							}
							//removing "," for last string
							if (str.endsWith(",")) {
								str = str.substring(0, str.length() - 1);
							}
							if(fileTempLinesErrReport.getTaskStatus()!=null&&fileTempLinesErrReport.getTaskStatus().equalsIgnoreCase("failure"))
							{
								fileTempLinesErrReport.setDetails("Failed to save at line number :"+str);
								if(fileTempLinesErrReport!=null&&fileTempLinesErrReport.getTaskStatus()!=null)
									finalErrorReport.add(fileTempLinesErrReport);
							}
							if(fileTempLinesErrReport.getTaskStatus()!=null && fileTempLinesErrReport.getTaskStatus().equalsIgnoreCase("Success"))
							{
								ErrorReport fileTempLinesErrorReport=new ErrorReport();
								fileTempLinesErrorReport.setTaskName("File Template Lines Save");
								if(FileTemplateLinesList.size()==fileTempLinesList.size())
								{
									count=2;
									fileTempLinesErrorReport.setTaskStatus("Success");
									finalErrorReport.add(fileTempLinesErrorReport);
								}
								else
								{
									fileTempLinesErrorReport.setTaskStatus("Failure");

									finalErrorReport.add(fileTempLinesErrorReport);
								}
							}

						}
					}
				}

				SourceProfileFileAssignments SPA=new SourceProfileFileAssignments();
				if(fileTemplatesPostingDTO.getSourceProfileFileAssignmentDTO()!=null && fileTemplatesPostingDTO.getSourceProfileFileAssignmentDTO().getSourceProfileId() != null)
				{
					TenantConfig  tenantConfig=tenantConfigRepository.findByTenantIdAndKey(tenantId, "LocalDirPath");
					SourceProfileFileAssignmentDTO SPADTO=fileTemplatesPostingDTO.getSourceProfileFileAssignmentDTO();
					log.info("SPADTO: temp id:"+SPADTO.getTemplateId());
					if(SPADTO.getId()!=null)
					{
						SPA.setId(SPADTO.getId());
					}
					if(SPADTO.getSourceProfileId()!=null)
						SPA.setSourceProfileId(SPADTO.getSourceProfileId());
					if(SPADTO.getFileNameFormat()!=null&&!SPADTO.getFileNameFormat().isEmpty())
						SPA.setFileNameFormat(SPADTO.getFileNameFormat());
					if(SPADTO.getFileDescription()!=null&&!SPADTO.getFileDescription().isEmpty())
						SPA.setFileDescription(SPADTO.getFileDescription());
					if(SPADTO.getFileExtension()!=null&&!SPADTO.getFileExtension().isEmpty())
						SPA.setFileExtension(SPADTO.getFileExtension());
					if(SPADTO.getFrequencyType()!=null&&!SPADTO.getFrequencyType().isEmpty())
						SPA.setFrequencyType(SPADTO.getFrequencyType());
					if(SPADTO.getDueTime()!=null&&!SPADTO.getDueTime().isEmpty())
						SPA.setDueTime(SPADTO.getDueTime());
					if(SPADTO.getDay()!=null)
						SPA.setDay(SPADTO.getDay());
					if(SPADTO.getSourceDirectoryPath()!=null&&!SPADTO.getSourceDirectoryPath().isEmpty())
						SPA.setSourceDirectoryPath(SPADTO.getSourceDirectoryPath());
					if(SPADTO.getLocalDirectoryPath()!=null&&!SPADTO.getLocalDirectoryPath().isEmpty())
						SPA.setLocalDirectoryPath(SPADTO.getLocalDirectoryPath());
					if(filetempRecord.getId()!=null)
						SPA.setTemplateId(filetempRecord.getId());
					SPA.setEnabledFlag(true);
					if(SPADTO.getCreatedBy()!=null)
						SPA.setCreatedBy(SPADTO.getCreatedBy());
					SPA.setCreatedDate(ZonedDateTime.now());
					if(SPADTO.getLastUpdatedBy()!=null)
						SPA.setLastUpdatedBy(SPADTO.getLastUpdatedBy());
					SPA.setLastUpdatedDate(ZonedDateTime.now());

					if(tenantConfig!=null)
						SPA.setLocalDirectoryPath(tenantConfig.getValue());
					SourceProfileFileAssignments sourceProfileAssgn=sourceProfileFileAssignmentsRepository.save(SPA);

					ErrorReport fileTempLinesErrorReport=new ErrorReport();
					fileTempLinesErrorReport.setTaskName("Source Profile Assignment Save");
					if(sourceProfileAssgn.getId()!=null)
					{
						count=3;
						fileTempLinesErrorReport.setTaskStatus("Success");
						finalErrorReport.add(fileTempLinesErrorReport);
					}
					else
					{
						fileTempLinesErrorReport.setTaskStatus("Failure");
						finalErrorReport.add(fileTempLinesErrorReport);

					}
				}
			}			
			if(count==3)
			{
				save="Success";
			}
		}
		return finalErrorReport;


	}

	/*
	 *//**Auhtor:Ravali
	 * @return details of source column values in a hashMap
	 *//*
	@GetMapping("/getFileTempMap")
	@Timed
	public List<HashMap> getFileTemp()
	{
		log.info("Rest Request to get distinct source details");
		//log.info("columnName :"+columnName);
		List<String> distinctList=fileTemplatesRepository.fetchDistinct();
		log.info("distinctList :"+distinctList);
		List<HashMap> FinalMap=new ArrayList<HashMap>();
		int k=0;
		for(int i=0;i<distinctList.size();i++)
		{
			HashMap map1=new HashMap();
			k=k+1;
			map1.put("id",k);
			map1.put("Source", distinctList.get(i));
			String displayName=distinctList.get(i).replaceAll("\\W", " ");
			map1.put("dispname", displayName);
			String img="";
			if(distinctList.get(i).equalsIgnoreCase("Chase"))
			{
				img="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAk1BMVEX///8AXLnw8PEAWLcYZrQAYMIAXr1ahbFOfaxKi818q9vt7u5bibhLfrEXaLoib73Y29/29vcsdsDR194accne4eS4w89ChMcNacXn6es5drjBzdoXbMJmndUAZcuktMVljLSctMw2fMOSrMd6nL9xn81UldYfbr0JZ8RJf7aYveOFnrxnlME/fbwKYLamwNuFs+KsN3Y0AAABXElEQVRIie3W23KCMBAG4ATctB4QAyIirQdapUht+/5P14gKG7JBOtObzvS/5f8gM4ENjLUjjyOco1HAGUvGSnC1TKS9H50SxibAtYBnFUnw4ZiAQ2ER4wwGFOAQO1TfyUDQgEOWmH0ZA7cBSshC9ayAQxAR/Q7AwZ9p4NLqABzy0Oh3Ai7mjXi/djqBEmmrfwPClrdF1d/Xt6zAdjqwJj8/o2yWUAHp2DNW1z9droN7Gf0+KAuvzmTWA3hraHLoAR7QxrjDf/BXwZeLvpA+IFpNm6x6ADUiUYi+Ce5FA88/A7BSa4geO7KVGEBQjdgN/kBaecIA/OuAXSwFpyN8BERej9fUJjDAo5Klc1ogoPUZC2nRALFMmZYwp0QNbmMVZeYTU7sGZl/tR2CKG1hvqB0lxBXAjn4HkqwtLmD9QvfVexsDAbxXW18d7if9x8Q9g9DeV6fJfohzSI3GNxONHJoVvN79AAAAAElFTkSuQmCC";
			}
			else if(distinctList.get(i).equalsIgnoreCase("BOA"))
			{
				img="data:image/png;base64,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";
			}
			else if(distinctList.get(i).equalsIgnoreCase("Wellsforgo"))
			{
				img="http://www.montrosechamber.org/wp-content/sabai/File/files/664e01a80cd59928f6152513282a9f9c.png";
			}
			else if(distinctList.get(i).equalsIgnoreCase("Citi"))
			{
				img="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAP1BMVEX///8AAJkzM8ymyvBmZsz/AACZmcwAAMzMzP//MzP/mZn/Zmb/zMwAM8z/fID/UFDx8fH/mczM7P/j4+Pq6urRYjM3AAAAuklEQVQ4jeWRSQKDIAxFMxFQtHa6/1mbQNUWtd23WTD9l08IAD8Zw9SFELp8OR/IrnaFGXb03s77ujKm3+inELLPwnVzaoGcSxKhFpM8HdRJyO1REiJxb0nAEpFEfbPogh6RIZo52QqRICG+6KRKKMWcdURRNiDO/rEWpfPtdVwBxfG9vBYQlG8AfQZ4LXcfsMeVO+QQUHu5eHsWgJTgugJgPbCgBOMzt2kUwI2l/CDrvWZ4Y3TzI/8cDzOPBHXjaCmjAAAAAElFTkSuQmCC";
			}
			map1.put("imagePath",img);
			List<HashMap> templateListMap=new ArrayList<HashMap>();
			List<FileTemplates> fileTempList=fileTemplatesRepository.findBySource(distinctList.get(i));
			log.info("fileTempList :"+fileTempList);
			for(FileTemplates fileTemp:fileTempList)
			{
				HashMap map2=new HashMap();
				map2.put("tempId", fileTemp.getId());
				map2.put("templateName", fileTemp.getTemplateName());
				templateListMap.add(map2);
			}
			log.info("templateListMap :"+templateListMap);
			map1.put("templateList", templateListMap);
			FinalMap.add(map1);
		}
		return FinalMap;
	}
	  */


	/**Auhtor:Ravali
	 * @param tableName
	 * @param columnName
	 * @return details of column values in a hashMap
	 */
	@GetMapping("/fetchFileTemplateByColumnNameAndTableName/{tableName}/{columnName}")
	@Timed
	public List<HashMap> getFileTempList(HttpServletRequest request,@PathVariable String tableName,@PathVariable String columnName)
	{
		HashMap map0=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map0.get("tenantId").toString());
		log.info("Rest Request to get distinct source details for tenant: "+tenantId);
		log.info("columnName :"+columnName);


		Query distinctList=em.createQuery("select distinct"+"("+columnName+")"+ " FROM "+tableName+" where tenant_id="+tenantId);
		log.info("distinctList : "+distinctList);
		List distinct = new ArrayList<String>();
		distinct =distinctList.getResultList();

		log.info("distinctList :"+distinctList);
		log.info("distinct :"+distinct);

		HashMap allMap=new HashMap();
		List<HashMap> FinalMap=new ArrayList<HashMap>();
		if(tableName.equalsIgnoreCase("RuleGroup"))
		{
			allMap.put("rulePurpose", "All");
			List<RuleGroup> ruleGroups = new ArrayList<RuleGroup>();
			ruleGroups = ruleGroupRepository.findByTenantIdOrderByIdDesc(tenantId);
			List<HashMap> allRuleGrpListMap=new ArrayList<HashMap>();
			for(int i=0;i<ruleGroups.size();i++)
			{
				Rules rule = new Rules();
				HashMap newRuleMap=new HashMap();
				newRuleMap.put("id", ruleGroups.get(i).getId());
				if(ruleGroups.get(i).getName() != null && !ruleGroups.get(i).getName().isEmpty())
					newRuleMap.put("name", ruleGroups.get(i).getName());
				allRuleGrpListMap.add(newRuleMap);
			}
			allMap.put("ruleGroups", allRuleGrpListMap);
		}
		else
		{
			allMap.put("dispname", "All");
		}


		FinalMap.add(allMap);


		int k=0;
		int allCount = 0;
		for(int i=0;i<distinct.size();i++)
		{
			if(tableName.equalsIgnoreCase("RuleGroup"))
			{

				if(distinct.get(i) != null)
				{
					HashMap ruleGroupMap = new HashMap();
					log.info("distinct.get(i) :"+(distinct.get(i)));
					List ruleGrpList=em.createQuery("select id FROM RuleGroup where tenantId="+tenantId +"and "+columnName+" ='"+distinct.get(i).toString()+"'").getResultList();
					log.info("ruleGrpList :"+ruleGrpList);
					List<HashMap> ruleGroupsListMap=new ArrayList<HashMap>();

					for(int j=0;j<ruleGrpList.size();j++)
					{
						HashMap ruleGroupWithRulesMap = new HashMap();
						HashMap ruleMap=new HashMap();
						log.info("Long.valueOf(ruleGrpList.get(j).toString()) :"+Long.valueOf(ruleGrpList.get(j).toString()));
						List<RuleGroupDetails> ruleGrpDetailsList=ruleGroupDetailsRepository.findByRuleGroupId(Long.valueOf(ruleGrpList.get(j).toString()));
						RuleGroup ruleGroup=ruleGroupRepository.findOne(Long.valueOf(ruleGrpList.get(j).toString()));
						log.info("ruleGroup :"+ruleGroup);
						ruleGroupWithRulesMap.put("id", ruleGroup.getIdForDisplay());
						if(ruleGroup!=null && ruleGroup.getName()!=null)
							ruleGroupWithRulesMap.put("name", ruleGroup.getName());
						if(ruleGrpDetailsList.size()>0)
						{

							log.info("ruleGrpDetailsList.size() :"+ruleGrpDetailsList.size());
							List<HashMap> map=new ArrayList<HashMap>();
							for(RuleGroupDetails ruleGrpDetail:ruleGrpDetailsList)
							{
								log.info("ruleGroup detail:"+ruleGrpDetail);
								//ruleMap.put("id", ruleGroup.getId());
								//ruleMap.put("name", ruleGroup.getName());
								List<Rules> rulesList=new ArrayList<Rules>();

								if(ruleGrpDetail.getRuleId()!=null){
									Rules rules=rulesRepository.findOne(ruleGrpDetail.getRuleId());
									if(rules != null )
									{
										HashMap newRuleMap=new HashMap();
										newRuleMap.put("id", rules.getId());
										if(rules.getRuleCode()!=null && !rules.getRuleCode().isEmpty())
											newRuleMap.put("ruleCode", rules.getRuleCode());
										map.add(newRuleMap);
									}

								}
							}
							log.info("map :"+map);
							ruleGroupWithRulesMap.put("rules", map);
							//ruleMap.put("rules", map);
							//log.info("ruleMap :"+ruleMap);
							//FinalMap.add(ruleMap);
							//log.info("FinalMap :"+FinalMap);
							ruleGroupsListMap.add(ruleGroupWithRulesMap);
						}
					}
					LookUpCode lKCode=lookUpCodeRepository.findByTenantIdAndLookUpCodeAndLookUpType(tenantId,distinct.get(i).toString(),"RULE_GROUP_TYPE");
					if(lKCode != null && lKCode.getMeaning() != null)
						ruleGroupMap.put("rulePurpose", lKCode.getMeaning());
					ruleGroupMap.put("ruleGroups", ruleGroupsListMap);
					ruleGroupMap.put("count", ruleGrpList.size());
					allCount = allCount+ ruleGrpList.size();
					FinalMap.add(ruleGroupMap);

				}

			}


			else
			{
				if(distinct.get(i) != null && !distinct.get(i).toString().isEmpty() && !distinct.get(i).toString().equals(""))
				{
					HashMap map1=new HashMap();
					k=k+1;
					String img="";
					if(distinct.get(i).toString().equalsIgnoreCase("Chase"))
					{
						img=chaseImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("BOA"))
					{
						img=bOAImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("Wellsforgo"))
					{
						img=wellsforgoImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("Citi"))
					{
						img=citiImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("GOOGLE_DRIVE"))
					{
						img=googleDriveImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("DROP_BOX"))
					{
						img=dropBoxImg;
					}
					else if(distinct.get(i).toString().equalsIgnoreCase("SFTP"))
					{
						img=sFTPImg;
					}


					String str=columnName+"='"+distinct.get(i)+"' and tenantId="+tenantId;
//					List entity=em.createQuery("select u FROM "+tableName+" u"+ " where "+str).getResultList();
					List entityRaw=em.createQuery("FROM "+tableName+ " where "+str).getResultList();

					List entity = new ArrayList();
					
					if(tableName.equalsIgnoreCase("FileTemplates"))
					{
						for(Object entObj:entityRaw)
						{
							FileTemplates ft = (FileTemplates)entObj;
							FileTempDTO ftDTO = new FileTempDTO();
							
							ftDTO.setId(ft.getIdForDisplay());
							ftDTO.setTemplateName(ft.getTemplateName());
							ftDTO.setDescription(ft.getDescription());
							ftDTO.setStartDate(ft.getStartDate());
							ftDTO.setEndDate(ft.getEndDate());
							ftDTO.setFileType(ft.getFileType());
							ftDTO.setStatus(ft.getStatus());
							ftDTO.setDelimiter(ft.getDelimiter());
							ftDTO.setSource(ft.getSource());
							ftDTO.setSkipRowsStart(ft.getSkipRowsStart());
							ftDTO.setSkipRowsEnd(ft.getSkipRowsEnd());
							ftDTO.setNumberOfColumns(ft.getNumber_of_columns());
							ftDTO.setHeaderRowNumber(ft.getHeaderRowNumber());
							
							entity.add(ftDTO);
						}
					}
					else
					{
						entity = entityRaw;
					}

					log.info("entity.size() :"+entity.size());
					map1.put("S.no",k);
					map1.put(columnName, distinct.get(i));
					String displayName=distinct.get(i).toString().replaceAll("\\W", " ");
					if(columnName.equalsIgnoreCase("connectionType"))
					{
						String lookUpType="CONNECTION_TYPE";
						LookUpCode meaning=lookUpCodeRepository.findByTenantIdAndLookUpCodeAndLookUpType(tenantId,distinct.get(i).toString(),lookUpType);
						map1.put("dispname", meaning.getMeaning());
					}

					else
						map1.put("dispname", displayName);
					map1.put("imagePath",img);
					map1.put("count",entity.size());
					map1.put("Lists", entity);
					allCount = allCount + entity.size();
					FinalMap.add(map1);
				}
			}

		}
		for(HashMap map : FinalMap)
		{
			if(map.containsValue("All"))
			{
				HashMap allmapObj = new HashMap<>();
				allmapObj = map;
				allmapObj.put("count", allCount);
				List entity =null;
				//tableName.class.getAnnotation(Table.);
					//entity=em.createQuery("SELECT * FROM "+tableName+ " WHERE tenant_id = "+tenantId).getResultList();
				allmapObj.put("Lists",entity);
			}
		}


		return FinalMap;
	}




	/**
	 * Author Kiran
	 * @param tenantId
	 * @param delimiter
	 * @param fileType
	 * @return
	 */
	@GetMapping("/fileTemplateLinesForBAi2Format")
	@Timed
	public List<FileTemplateDataDTO> findDelimiterAndFileExtensionWhenFileUploaded(
			HttpServletRequest request,
			//@RequestParam Long tenantId, 
			@RequestParam(value="delimiter", required=false) String delimiter ,
			@RequestParam(value="fileType", required=false) String fileType)
			{

		List<FileTemplateDataDTO> fileTempDtoList = new ArrayList<FileTemplateDataDTO>();

		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());
		log.info("Rest request to get template lines of Bai2 for tenant: "+tenantId);

		if(fileType!=null && fileType.equalsIgnoreCase("BAI2"))
		{

			log.info("Setting Columns for BAI2 File Format");
			FileTemplateDataDTO fileTempDto = new FileTemplateDataDTO();

			fileTempDto.setFileType(fileType);
			int val=0;
			try{
				val=Integer.valueOf(delimiter);
			}
			catch (NumberFormatException e) 
			{
				System.out.println("NumberFormatException for UserId: " + e.getMessage());
			}
			log.info("Delimiter val and tenantId:-> "+String.valueOf(val)+" and "+tenantId);

			LookUpCode lookUpCode=lookUpCodeRepository.findByLookUpTypeAndLookUpCodeAndTenantId("DELIMITER",String.valueOf(val),tenantId);
			if(lookUpCode!=null && lookUpCode.getDescription()!=null)
			{
				fileTempDto.setDelimiter(lookUpCode.getLookUpCode());
				fileTempDto.setDelimeterDescription(lookUpCode.getDescription());
			}


			//String rowIdentifier="BAI2";rule-group-approvals.component.ts
			JSONParser parser = new JSONParser();
			List<Object> objList = null;
			try {
				objList = (List<Object>) parser.parse(new BufferedReader(new InputStreamReader(this.getClass().getClassLoader().getResourceAsStream("jsonFile/BAI2Columns.json"))));
				log.info("Size "+objList.size());
				int k=0;
				List<String> headersList = new ArrayList<String>(); 
				List<FileTemplateLinesDTO> fileTemp = new ArrayList<FileTemplateLinesDTO>();
				for(Object obj : objList)
				{
					JSONObject jsonObject = (JSONObject) obj;
					//String recordIdentifier = (String) jsonObject.get("identifierType");
					//						log.info("recordIdentifier: "+recordIdentifier+" and rowIdentifier: "+rowIdentifier);
					//
					//						if(recordIdentifier.equalsIgnoreCase(rowIdentifier))
					//						{
					//							log.info("recordIdentifier: "+recordIdentifier+" rowIdentifier: "+rowIdentifier);
					JSONArray columnNames = (JSONArray) jsonObject.get("columns");
					for(int i = 0; i < columnNames.size();i++) 
					{
						JSONObject innerObj = (JSONObject) columnNames.get(i);
						String colNum= (String) innerObj.get("columnNumber");
						String colHeader= (String) innerObj.get("columnHeader");
						String recordStrtRow= (String) innerObj.get("recordStartRow");
						String recordType= (String) innerObj.get("recordType");

						FileTemplateLinesDTO fileTempData= new FileTemplateLinesDTO();

						int num=i+1;
						fileTempData.setColumnNumber(num);
						if(i<9)
						{
							fileTempData.setMasterTableReferenceColumn("FIELD_0"+(num));
						}
						else{
							fileTempData.setMasterTableReferenceColumn("FIELD_"+(num));
						}
						//log.info("recordStrtRow: "+recordStrtRow);//+" and recordIdentifier: "+recordIdentifier);
						fileTempData.setRecordStartRow(recordStrtRow);
						fileTempData.setColumnHeader(colHeader);
						fileTempData.setRecordTYpe(recordType);
						//								fileTempData.setRecordStartRow(recordStartRow);
						headersList.add(colHeader);

						//	log.info("columnNames.size(): "+columnNames.size()+" and i: "+i);
						if(i == (columnNames.size()-1))
						{
							fileTempData.setLastMasterTableRefCol(true);
							fileTempData.setLastColNumber(true);
						}

						fileTemp.add(fileTempData);

						//log.info("===> key: "+colNum+" Value: "+colHeader);
					}
				}
				//}
				fileTempDto.setHeaders(headersList);
				fileTempDto.setStatus("Success");
				fileTempDto.setTemplateLines(fileTemp);
				fileTempDtoList.add(fileTempDto);
				return fileTempDtoList;
			} catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

			//------------------->
		}
		else if(fileType!=null && (fileType.equalsIgnoreCase("BAI2_ACH") || fileType.equalsIgnoreCase("BAI2_LOCKBOX")))
		{


			log.info("Setting Columns for BAI2_ACH/BAI2_LOCKBOX File Format:- "+fileType);
			FileTemplateDataDTO fileTempDto = new FileTemplateDataDTO();

			fileTempDto.setFileType(fileType);
			fileTempDto.setDelimiter(null);
			fileTempDto.setDelimeterDescription(null);


			//String rowIdentifier="BAI2";rule-group-approvals.component.ts
			JSONParser parser = new JSONParser();
			List<Object> objList = null;
			try {
				if(fileType.equalsIgnoreCase("BAI2_ACH"))
					objList = (List<Object>) parser.parse(new BufferedReader(new InputStreamReader(this.getClass().getClassLoader().getResourceAsStream("jsonFile/BAI2_ACH_Columns.json"))));
				else if(fileType.equalsIgnoreCase("BAI2_LOCKBOX"))
					objList = (List<Object>) parser.parse(new BufferedReader(new InputStreamReader(this.getClass().getClassLoader().getResourceAsStream("jsonFile/BAI2_LOCKBOX_Columns.json"))));
				log.info("Size In Ach/LockBox"+objList.size());
				int k=0;
				List<String> headersList = new ArrayList<String>(); 
				List<FileTemplateLinesDTO> fileTemp = new ArrayList<FileTemplateLinesDTO>();
				for(Object obj : objList)
				{
					JSONObject jsonObject = (JSONObject) obj;
					//String recordIdentifier = (String) jsonObject.get("identifierType");
					//						log.info("recordIdentifier: "+recordIdentifier+" and rowIdentifier: "+rowIdentifier);
					//
					//						if(recordIdentifier.equalsIgnoreCase(rowIdentifier))
					//						{
					//							log.info("recordIdentifier: "+recordIdentifier+" rowIdentifier: "+rowIdentifier);
					JSONArray columnNames = (JSONArray) jsonObject.get("columns");
					for(int i = 0; i < columnNames.size();i++) 
					{
						JSONObject innerObj = (JSONObject) columnNames.get(i);
						String colNum= (String) innerObj.get("columnNumber");
						String colHeader= (String) innerObj.get("columnHeader");
						String recordStrtRow= (String) innerObj.get("recordStartRow");
						String recordType= (String) innerObj.get("recordType");
						String posBegin= (String) innerObj.get("positionBegin");
						String posEnd= (String) innerObj.get("positionEnd");

						FileTemplateLinesDTO fileTempData= new FileTemplateLinesDTO();

						int num=i+1;
						fileTempData.setColumnNumber(num);
						if(i<9)
						{
							fileTempData.setMasterTableReferenceColumn("FIELD_0"+(num));
						}
						else{
							fileTempData.setMasterTableReferenceColumn("FIELD_"+(num));
						}
						//log.info("recordStrtRow: "+recordStrtRow);//+" and recordIdentifier: "+recordIdentifier);
						fileTempData.setRecordStartRow(recordStrtRow);
						fileTempData.setColumnHeader(colHeader);
						fileTempData.setRecordTYpe(recordType);
						fileTempData.setPositionBegin(Integer.parseInt(posBegin));
						fileTempData.setPositionEnd(Integer.parseInt(posEnd));
						//								fileTempData.setRecordStartRow(recordStartRow);
						headersList.add(colHeader);

						//	log.info("columnNames.size(): "+columnNames.size()+" and i: "+i);
						if(i == (columnNames.size()-1))
						{
							fileTempData.setLastMasterTableRefCol(true);
							fileTempData.setLastColNumber(true);
						}

						fileTemp.add(fileTempData);

						//						log.info("===> key: "+colNum+" Value: "+colHeader);
					}
				}
				//}
				fileTempDto.setHeaders(headersList);
				fileTempDto.setStatus("Success");
				fileTempDto.setTemplateLines(fileTemp);
				fileTempDtoList.add(fileTempDto);
				return fileTempDtoList;
			} catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

			//------------------->

		}

		return fileTempDtoList;

			}



	/**
	 * Author Kiran, Ravali
	 * @param filePath
	 * @return
	 * @throws IOException
	 * To Find the delimiter when file uploaded and to save columns in the file templates lines as per row details of line one in file
	 * @throws JSONException 
	 */

	@PostMapping("/findDelimiterAndFileExtension")
	@Timed
	public List<FileTemplateDataDTO> findDelimiterAndFileExtensionWhenFileUploaded(
			HttpServletRequest request,
			@RequestParam("file") MultipartFile file, 
			@RequestParam(required=false) String multipleIdentifiersList,
			@RequestParam(value = "skipStartRow" , defaultValue = "0") int skipStartRow,
			@RequestParam(value = "skipEndRow" , defaultValue = "0") int skipEndRow,
			//@RequestParam Long tenantId, 
			@RequestParam(value="templateColumns", required=false) String templateColumns, 
			@RequestParam(value="rowIdentifier", required=false) String rowIdentifier,
			@RequestParam(value="delimiter", required=false) String delimiter ,
			@RequestParam(value="multipleIdentifier", required=false) boolean multipleIdentifier)
			{

		List<FileTemplateDataDTO> fileTempDtoList = new ArrayList<FileTemplateDataDTO>();
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());

		log.info("====== * Finding Delimiter and file excetion Api, filename:- "+file.getOriginalFilename()+" Delimiter: "+delimiter+" and rowIdentifier: "+rowIdentifier+" tenant: "+tenantId);


		InputStream inputStream;
		try 
		{
			inputStream = file.getInputStream();
			BufferedReader bfrReader = null;
			try {
				/** Here we are reading the file that is uploaded */
				bfrReader = new BufferedReader(new InputStreamReader(inputStream, "UTF-8"));
			} catch (UnsupportedEncodingException e) {
				e.printStackTrace();
			}
			String givenLine="";
			List<HashMap<Integer, Integer>> occeranceList = new ArrayList<HashMap<Integer,Integer>>(); // to find the delimiter maximum occurrences from 10 lines 
			Set<Integer> keys = new HashSet<Integer>(); // Unique Keys/ delimiters

			int tempValue = 0; // get the count of 10 lines

			String criteria = null;
			int posBeging=0;
			int posEnd=0;
			FileTemplateDataDTO result=null;

			//When Delimiter is given
			if(delimiter!=null && !delimiter.isEmpty())
			{
				System.out.println("When Delimiter is given");
				log.info("Delimiter: "+delimiter);
				int val=0;
				try{
					val=Integer.valueOf(delimiter);
				}
				catch (NumberFormatException e) 
				{
					System.out.println("NumberFormatException for UserId: " + e.getMessage());
				}
				char charDigit = (char) val;
				//				char charDigit = delimiter.charAt(0);
				log.info("Reading the data using Delimiter: "+charDigit);
				System.out.println("***************************************multipleIdentifiersList: "+multipleIdentifiersList);


				try {

					if(multipleIdentifiersList!=null)
					{

						/**Code to parse List of String to Json or Hashmap */
						ObjectMapper objMapper = new ObjectMapper();
						TypeFactory typeFact = objMapper.getTypeFactory();
						List<MultipleIdentifiersDTO> multiIdList= objMapper.readValue(multipleIdentifiersList, typeFact.constructCollectionType(List.class,MultipleIdentifiersDTO.class));

						for(MultipleIdentifiersDTO multiId:multiIdList)
						{
							System.out.println("Criteria: "+multiId.getCriteria());
							System.out.println("RowIdentifier: "+multiId.getRowIdentifier());
							System.out.println("positionStart: "+multiId.getPositionStart());
							System.out.println("positionEnd: "+multiId.getPositionEnd());


							rowIdentifier=multiId.getRowIdentifier();
							criteria = multiId.getCriteria();
							if(multiId.getPositionStart()!=0)
								posBeging=multiId.getPositionStart();
							if(multiId.getPositionEnd()!=0)
								posEnd=multiId.getPositionEnd();


							result=findDelimiterAndFileExtensionService.readingTemplateFileData(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifier,multipleIdentifier,criteria,posBeging,posEnd);
							//					}
							//					FileTemplateDataDTO result=findDelimiterAndFileExtensionService.readingTemplateFileData(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifierList.get(0));
							log.info("Result:-> "+result);
							if(result!=null)
							{

								fileTempDtoList.add(result);
								//								return fileTempDtoList;
							}
						}
						return fileTempDtoList;
					}
					else{
						result=findDelimiterAndFileExtensionService.readingTemplateFileDataOld(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifier);
						if(result!=null)
						{
							fileTempDtoList.add(result);
							return fileTempDtoList;
						}
					}

				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
			// When delimiter is not given 
			else
			{
				System.out.println("When delimiter is not given");
				if(templateColumns!=null && templateColumns.equalsIgnoreCase("Variable Columns"))
				{
					while((givenLine = bfrReader.readLine()) != null && tempValue <11)
					{
						/**
						 * Below code is for Dfr file to get the delimiter based on the record identifier
						 * */

						if(rowIdentifier!=null)
						{
							int rowIL=rowIdentifier.length();
							String dataRow=givenLine.substring(0,rowIL);
							//log.info("Row Identifier in file: "+dataRow+" and given row Identifier: "+rowIdentifier);
							if(dataRow.equalsIgnoreCase(rowIdentifier))
							{
								log.info("Given Line if row identifier is given:->"+givenLine);
								List<Integer> listInt = findDelimiterAndFileExtensionService.toGetIndexNumbers(givenLine); 
								//log.info("listInt:->"+listInt);
								for(int k=0;k<(listInt.size()/2);k++)
								{
									List<Integer> listIntInside=findDelimiterAndFileExtensionService.toGetIndexNumbers(givenLine);
									//log.info("listIntInside:-> "+listIntInside);
									int start =listIntInside.get(0);
									int end = (listIntInside.get(1)+1);

									StringBuffer buf = new StringBuffer(givenLine);
									String afterRemoving = buf.replace(start, end, "").toString(); 
									givenLine = afterRemoving;
								}
								//log.info("After Removing "+givenLine);
								HashMap<Integer, Integer> occerance = findDelimiterAndFileExtensionService.toFindDelimiter(givenLine);
								//log.info("occerance.keySet():"+occerance.keySet());
								//log.info("occerance.size():"+occerance.size());
								if(occerance.size()!=0)
								{
									keys.addAll(occerance.keySet());
									occeranceList.add(occerance);
								}
								tempValue++;
							}
						}
						else{
							log.info("rowIdentifier Not Given");
						}
					}
				}
				else{
					while((givenLine = bfrReader.readLine()) != null && tempValue <11)
					{
						log.info("Given Line is:->"+givenLine);
						List<Integer> listInt = findDelimiterAndFileExtensionService.toGetIndexNumbers(givenLine); 
						//log.info("listInt:->"+listInt);
						for(int k=0;k<(listInt.size()/2);k++)
						{
							List<Integer> listIntInside=findDelimiterAndFileExtensionService.toGetIndexNumbers(givenLine);
							//log.info("listIntInside:-> "+listIntInside);
							int start =listIntInside.get(0);
							int end = (listIntInside.get(1)+1);

							StringBuffer buf = new StringBuffer(givenLine);
							String afterRemoving = buf.replace(start, end, "").toString(); 
							givenLine = afterRemoving;
						}
						//log.info("After Removing "+givenLine);
						HashMap<Integer, Integer> occerance = findDelimiterAndFileExtensionService.toFindDelimiter(givenLine);
						//log.info("occerance.keySet():"+occerance.keySet()+" and occerance.size(): "+occerance.size());
						if(occerance.size()!=0)
						{
							keys.addAll(occerance.keySet());
							occeranceList.add(occerance);
						}
						tempValue++;
					}

				}
				log.info("occeranceList:>>"+occeranceList);
				Integer delimiterObatined=findDelimiterAndFileExtensionService.findTheDelimiter(occeranceList, keys);
				log.info("Result(Delimiter Obtained):- "+delimiterObatined);
				log.info("================= Success Found Delimiter ==================");


				int val=0;
				try{
					val=Integer.valueOf(delimiterObatined);}
				catch (NumberFormatException e) 
				{
					System.out.println("NumberFormatException for UserId: " + e.getMessage());
				}
				char charDigit = (char) val;
				//				char charDigit = delimiter.charAt(0);
				log.info("Reading the data using Delimiter: "+charDigit);

				try{
					if(multipleIdentifiersList!=null && !multipleIdentifiersList.isEmpty())
					{
						/**Code to parse List of String to Json or Hashmap */
						ObjectMapper objMapper = new ObjectMapper();
						TypeFactory typeFact = objMapper.getTypeFactory();
						List<MultipleIdentifiersDTO> multiIdList= objMapper.readValue(multipleIdentifiersList, typeFact.constructCollectionType(List.class,MultipleIdentifiersDTO.class));

						for(MultipleIdentifiersDTO multiId:multiIdList)
						{
							System.out.println("Criteria: "+multiId.getCriteria());
							System.out.println("RowIdentifier: "+multiId.getRowIdentifier());
							System.out.println("positionStart: "+multiId.getPositionStart());
							System.out.println("positionEnd: "+multiId.getPositionEnd());


							rowIdentifier=multiId.getRowIdentifier();
							criteria = multiId.getCriteria();
							if(multiId.getPositionStart()!=0)
								posBeging=multiId.getPositionStart();
							if(multiId.getPositionEnd()!=0)
								posEnd=multiId.getPositionEnd();

							result=findDelimiterAndFileExtensionService.readingTemplateFileData(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifier,multipleIdentifier,criteria,posBeging,posEnd);
							//					FileTemplateDataDTO result=findDelimiterAndFileExtensionService.readingTemplateFileData(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifierList.get(0));
							log.info("Result1:-> "+result);
							if(result!=null)
							{
								fileTempDtoList.add(result);
								//								return fileTempDtoList;
							}
						}
						return fileTempDtoList;
					}
					else{
						result=findDelimiterAndFileExtensionService.readingTemplateFileDataOld(charDigit,file,skipStartRow,skipEndRow,tenantId,rowIdentifier);
						log.info("Result2:-> "+result);
						if(result!=null)
						{
							fileTempDtoList.add(result);
							return fileTempDtoList;
						}
					}
				}
				catch (IOException e) 
				{
					e.printStackTrace();
				}

			}
		} 
		catch (IOException e) {
			System.out.println("Exception");
			e.printStackTrace();
		}
		//}
		return null;
			}


	@GetMapping("/testView/{tableName}/{tenantId}")
	@Timed
	public Query testView(@PathVariable String tableName, @PathVariable Long tenantId)
	{
		log.info("Rest Request to get distinct source details");

		Query distinctList=em.createQuery(" FROM "+tableName);
		log.info("distinctList: "+distinctList);
		return distinctList;
	}
	/*@GetMapping("/fileTemplateswithStatus")
	@Timed
	public List<FileTemplateDTO> fetchFileTemplatesWithStatus(@RequestParam(value="sourceProfileId") Long sourceProfileId)
	{
		log.info("Rest Request to get file templates with source profile id");
		List<FileTemplateDTO> fileTemplatesDTOList = new ArrayList<FileTemplateDTO>();
		List<SourceProfileFileAssignments> spas = new ArrayList<SourceProfileFileAssignments>();
		spas = sourceProfileFileAssignmentsRepository.findBySourceProfileId(sourceProfileId);
		for(SourceProfileFileAssignments spa : spas)
		{
			FileTemplateDTO fileTemplateDTO = new FileTemplateDTO();
			if(spa.getId() != null)
			{
				fileTemplateDTO.setSPAId(spa.getId());
			}
			if(spa.getTemplateId() != null)
			{
				FileTemplates ft = new FileTemplates();
				fileTemplateDTO.setSourceProfileId(sourceProfileId);
				fileTemplateDTO.setFileNameFormat(spa.getFileNameFormat());
				fileTemplateDTO.setFileExtension(spa.getFileExtension());
				fileTemplateDTO.setFileDescription(spa.getFileDescription());
				fileTemplateDTO.setTemplateId(spa.getTemplateId());
				ft = fileTemplatesRepository.findOne(spa.getTemplateId());
				if(ft != null && ft.getTemplateName() != null)
					fileTemplateDTO.setTemplateName(ft.getTemplateName());
				if(ft.getStatus() != null)
					fileTemplateDTO.setTemplateStatus(ft.getStatus());
			}
			if(spa.getHold() != null)
				fileTemplateDTO.setHold(spa.getHold());
			if(spa.getHoldReason() != null)
				fileTemplateDTO.setHoldReason(spa.getHoldReason() );
			if(spa.getSourceDirectoryPath() != null)
				fileTemplateDTO.setSourceDirectoryPath(spa.getSourceDirectoryPath() );
			if(spa.getLocalDirectoryPath() != null)
				fileTemplateDTO.setLocalDirectoryPath(spa.getLocalDirectoryPath());
			fileTemplatesDTOList.add(fileTemplateDTO);
		}
		return fileTemplatesDTOList;
	}*/


	/**
	 * Author : Shobha
	 * @param fileName
	 * @param sourceProfileId
	 * @param fileTemplatesDTOList
	 * @return
	 */
	@GetMapping("/fetchMatchedTemplatesByFileAndProfile")
	@Timed
	public List<String[]> fetchMatchedTemplatesByFileAndProfile(@RequestParam("fileName") String fileName,@RequestParam("fileTemplatesDTOList") String fileTemplatesDTOList)
	{
		log.debug("Rest request to fetch matched templates by file and profile"+fileName);
		List<String[]> matchedTemplatesWithNamesAndId= new ArrayList<String[]> ();

		try{
			ObjectMapper objMapper = new ObjectMapper();
			TypeFactory typeFact = objMapper.getTypeFactory();
			List<FileTemplateDTO> spas = objMapper.readValue(fileTemplatesDTOList, typeFact.constructCollectionType(List.class,FileTemplateDTO.class));
			for(FileTemplateDTO spa : spas)
			{

				String fileNameFormat = null;
				try{
					fileNameFormat = spa.getFileNameFormat();
					if(fileNameFormat.contains("*"))
					{
						fileNameFormat = fileNameFormat.replaceAll("\\*", "(.*)");
					}
				}
				catch(Exception exp)
				{
					System.out.println("fileNameFormat cannot be null");
				}


				if(fileName.matches(fileNameFormat))
				{
					String[] strArr = new String[3];
					//Process or function
					strArr[0]=spa.getTemplateId().toString();
					strArr[1]=spa.getTemplateName();
					strArr[2]=spa.getSPAid().toString();

					matchedTemplatesWithNamesAndId.add(strArr);
				}
			}
		}
		catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return matchedTemplatesWithNamesAndId;

	}



	/**
	 * Author Kiran  
	 * @param file
	 * @param tenantId
	 * @param userId
	 * @param srcPrfAsmtlId
	 * @return
	 * @throws IOException
	 * @throws SftpException
	 */

	@PostMapping("/DropZoneTransformationForDropArea")
	@Timed
	public void transformationUsingDropZoneForDropArea(HttpServletRequest request,
			@RequestParam Long srcPrfAsmtlId,
			@RequestParam("file") MultipartFile file) 
	{
		log.info("Rest Post Api to Transform the file after file Drop");
		HashMap map0=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map0.get("tenantId").toString());
		Long userId=Long.parseLong(map0.get("userId").toString());
		SourceProfileFileAssignments srcFileAsmtDetails=sourceProfileFileAssignmentsRepository.findOne(srcPrfAsmtlId);

		if(srcFileAsmtDetails!=null)
		{
			InputStream inputStream;
			try {
				inputStream = new BufferedInputStream(file.getInputStream());
				String fileName=file.getOriginalFilename();

				if(inputStream!=null)
					dataTransformationProcessMethod(request,inputStream, fileName, userId, tenantId, srcPrfAsmtlId,srcFileAsmtDetails);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		else{
			log.info("Invalid Source Profile Asmt Id");
		}
		//return null;
	}


	@PostMapping("/DropZoneTransformationForDropBoxAndDrive")
	@Timed
	public void transformationUsingDropZoneForDropBoxAndDrive(HttpServletRequest request,

			@RequestParam Long srcPrfAsmtlId,
			@RequestParam String accessToken,
			@RequestParam String fileId)
	{

		log.info("Rest Post Api to Transform the file after file Drop");
		HashMap map0=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map0.get("tenantId").toString());
		Long userId=Long.parseLong(map0.get("userId").toString());
		SourceProfileFileAssignments srcFileAsmtDetails=sourceProfileFileAssignmentsRepository.findOne(srcPrfAsmtlId);
		InputStream inputStream=null;
		String fileName=null;
		if(srcFileAsmtDetails!=null)
		{
			DbxRequestConfig config = new DbxRequestConfig("com.dropbox/V2");
			DbxClientV2 clientV2 = new DbxClientV2(config, accessToken);
			FullAccount account;
			try {
				account = clientV2.users().getCurrentAccount();
				log.info("Connected with drop box using account: "+account.getName().getDisplayName());
			} 
			catch (DbxException e) {
				e.printStackTrace();
			}
			try 
			{
				Metadata md=clientV2.files().getMetadata("id:Q6fLPAnfb4AAAAAAAAAACQ");
				fileName=md.getName();
				log.info("fileName- "+md.getName());

				DbxDownloader<FileMetadata> downloder =clientV2.files().downloadBuilder(fileId).start();
				//log.info("--> "+downloder.getResult());
				inputStream = downloder.getInputStream();

			} 
			catch (DbxException e) 
			{
				e.printStackTrace();
			}

			if(inputStream!=null )
				dataTransformationProcessMethod(request,inputStream, fileName, userId,tenantId, srcPrfAsmtlId,srcFileAsmtDetails);

		}
		else{
			log.info("Invalid Source Profile Asmt Id");
		}
		//return null;
	}




	public void dataTransformationProcessMethod(HttpServletRequest request,
			InputStream inputStream, 
			String fileName,
			Long userId,
			Long tenantId, 
			Long srcPrfAsmtlId,
			SourceProfileFileAssignments srcFileAsmtDetails)
	{
		String targetFolderPath=srcFileAsmtDetails.getLocalDirectoryPath();
		log.info("fileName: "+fileName);
		DateFormat df = new SimpleDateFormat("yyyyMMddhhmmss");
		String filename1 = "";
		String filename2 = "";
		if ((fileName.lastIndexOf(".") != -1) && (fileName.lastIndexOf(".") != 0))
		{
			int val = fileName.lastIndexOf(".");
			filename1 = fileName.substring(0, val);
			filename2 = fileName.substring(val, fileName.length());
		}
		String fileWithTimeStamp = filename1 + "_" + df.format(new Date()) + filename2;
		System.out.println("TemplateName with timestamp:- " + fileWithTimeStamp);


//		String formConfig="Local_Connection";
//		FormConfig formDetails=formConfigRepository.findByFormConfig(formConfig);
		
		TenantConfig tenantConfig = tenantConfigRepository.findByTenantIdAndKey(tenantId, "dataExtractionCentralRepositoryConn");


		if(tenantConfig!=null)
		{
			String str=tenantConfig.getValue();
			String[] strVals=str.split(",");
			String host=strVals[0];
			String port=strVals[1];
			String userName=strVals[2];
			String password=strVals[3];

			Channel channel =sftpConnection(host, port, userName,password);
			ChannelSftp targetchannelSftp = (ChannelSftp)channel;


			putFile(targetchannelSftp, targetFolderPath, fileWithTimeStamp, inputStream);

			Vector<ChannelSftp.LsEntry> filesMoved;
			try 
			{
				filesMoved = targetchannelSftp.ls(targetFolderPath);

				BatchHeader batchHdrDetails=null;
				if (filesMoved.size() != 0)
				{
					log.info("File Moved to local Dir Path: "+targetFolderPath);

					Long profileId=srcFileAsmtDetails.getSourceProfileId();
					SourceProfiles srcPrfLDetails=sourceProfilesRepository.findOne(profileId);

					batchHdrDetails=new BatchHeader();
					batchHdrDetails.setBatchName("Batch_"+srcPrfLDetails.getSourceProfileName());
					batchHdrDetails.setCreatedBy(userId);
					batchHdrDetails.setCreatedDate(ZonedDateTime.now());
					batchHdrDetails.setExtractedDatetime(ZonedDateTime.now());
					batchHdrDetails.setExtractionStatus("1 file(s) - EXTRACTED");
					batchHdrDetails.setTenantId(tenantId);
					batchHdrDetails.setType("Manual");
					BatchHeader batchHdr=batchHeaderRepository.save(batchHdrDetails);  

					batchHdrDetails=batchHeaderRepository.findOne(batchHdr.getId());
					batchHdrDetails.setBatchName("Batch_"+srcPrfLDetails.getSourceProfileName()+"_"+batchHdr.getId());
					batchHeaderRepository.save(batchHdrDetails);


					SourceFileInbHistory srcFileHstry = new SourceFileInbHistory();
					srcFileHstry.setProfileId(profileId);
					srcFileHstry.setFileName(fileWithTimeStamp);
					srcFileHstry.setFileReceivedDate(ZonedDateTime.now());
					srcFileHstry.setLocalDirPath(targetFolderPath);
					srcFileHstry.setFileExt(filename2);
					srcFileHstry.setCreatedBy(userId);
					srcFileHstry.setCreationDate(ZonedDateTime.now());
					srcFileHstry.setSrcPrfFileAsmtId(srcPrfAsmtlId);
					srcFileHstry.setTenantId(tenantId);
					srcFileHstry.setStatus("Extracted");
					srcFileHstry.setBatchId(batchHdr.getId());
					srcFileHstry.setHold(false);
					sourceFileInbHistoryRepository.save(srcFileHstry);

					/**Code to start Transformation Process**/

					HashMap parameterSet = new HashMap();
					parameterSet.put("param1", profileId);
					parameterSet.put("param2", srcFileAsmtDetails.getTemplateId());
					//parameterSet.put("param3", "null");
					//parameterSet.put("param4", "null");

					log.info("Api call to Intiate Job for Data Transformation process: "+parameterSet);
					ResponseEntity response=jobDetailsResource.jobIntiateForAcctAndRec(request, "DataTransformation", parameterSet);
				}
				else
				{
					log.info("File Not moved to the central repository path");
				}
			} catch (SftpException e)
			{
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		else{
			log.info("Tenant Configuration details were not present");
		}
	}


	public Channel sftpConnection(String host, String prt, String userName, String password)
	{
		Channel channel = null ;
		//System.out.println("port:"+prt);
		int port=0;
		try{
			port = Integer.parseInt(prt);}
		catch(NumberFormatException ex)
		{
			System.out.println("NumberFormat Exception for port: "+prt);
			System.exit(0);
		}
		System.out.println("Host: "+host+" Port: "+port+" UserName "+userName+" Password: "+password);
		Session session = null;
		try 
		{
			JSch jsch = new JSch();
			session = jsch.getSession(userName, host, port);
			session.setPassword(password);
			java.util.Properties config = new java.util.Properties();
			config.put("StrictHostKeyChecking", "no");
			session.setConfig(config);
			//System.out.println("==========config========="+config);
			session.connect();
			channel = session.openChannel("sftp");
			//System.out.println("==========channel=========="+channel);
			channel.connect();
			System.out.println("channel success connection :"+channel.isConnected());
		} 
		catch (Exception ex) {
			ex.printStackTrace();
			System.out.println("Failed connection");
		}

		return channel ;
	}



	public void putFile(Channel channel, String targetFolder, String fileToTransfer, InputStream sourceStream)
	{
		System.out.println("targetFolder: "+targetFolder+" --> file name: "+fileToTransfer);
		ChannelSftp channelSftp = (ChannelSftp) channel;

		//		String tTargetFolder = targetFolder;
		//System.out.println("Target Folder: "+targetFolder);
		/***/
		try {
			channelSftp.cd("/");
		} catch (SftpException e2) {
			// TODO Auto-generated catch block
			e2.printStackTrace();
		}
		String[] folders = targetFolder.split( "/" );
		for ( String folder : folders ) {
			//System.out.println("folder: "+folder);
			if ( folder.length() > 0 ) {
				try {
					channelSftp.cd( folder );
					//	System.out.println("Change Folder: "+folder);
				}
				catch ( SftpException e ) {
					try {
						channelSftp.mkdir( folder );
						//System.out.println("Creating Folder: "+folder);
						channelSftp.chmod(0777, folder);
						channelSftp.cd( folder );
						//System.out.println("Change Folder: "+folder);
					} catch (SftpException e1) {
						e1.printStackTrace();
					}

				}
			}
		}
		/***/
		//	channelSftp.mkdir(targetFolder);

		try {
			channelSftp.cd(targetFolder);
		}
		catch(Exception e)
		{
			log.info("Target folder not found");
		}
		try {	
			FileInputStream fis = null;
			if(sourceStream == null)
			{
				File f = new File(fileToTransfer);
				fis = new FileInputStream(f);
				channelSftp.put(fis, f.getName());
			}
			else
			{
				System.out.println("Copying file to server ");
				//	System.out.println("sourceStream: "+sourceStream+" fileToTransfer: "+fileToTransfer);
				channelSftp.put(sourceStream, fileToTransfer);
			}
			if(fis != null)
			{
				try {
					fis.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}
		catch (SftpException e) {
			System.out.println("SFTP Exception "+e.getMessage());
			e.printStackTrace();
			disconnect(channel);
		} catch (FileNotFoundException e) {
			System.out.println("File Not Found Exception "+e.getMessage());
			e.printStackTrace();
		}
	}

	public  void disconnect(Channel channel)
	{
		try {
			Session session = channel.getSession();
			channel.disconnect();
			session.disconnect();
		} catch (JSchException e) {
			e.printStackTrace();
		}
	}


	/**
	 * Author1: Ravali
	 * Author2: Swetha [Added DFR specific template retrieval]
	 * GET  /file-templates : get all the fileTemplates.
	 *
	 * @param pageable the pagination information
	 * @return the ResponseEntity with status 200 (OK) and the list of fileTemplates in body
	 * @throws URISyntaxException 
	 */
	/*@SuppressWarnings("unchecked")
	@GetMapping("/fileTemplatesByTenantId22")
	@Timed
	public List<FileTmpDTO> getAllFileTemplatesDfr22(@RequestParam(value = "page" , required = false) Integer offset,
			@RequestParam(value = "per_page", required = false) Integer limit, @RequestParam(required = false) String formType, HttpServletRequest request,
			@RequestParam(required = false) String sortColName, @RequestParam(required = false) String sortOrder) throws URISyntaxException {
		log.debug("REST request to get a page of FileTemplates with formType: "+formType);

		HashMap map=new HashMap();
		List<FileTmpDTO> fileTmpList=new ArrayList<FileTmpDTO>();
		List<Long> ftIds=new ArrayList<Long>();
		List<Long> multIdentifierIds=new ArrayList<Long>();
		List<FileTmpDTO> fileTmpListWithDfrDivided=new ArrayList<FileTmpDTO>();
		List<FileTmpDTO> finList=new ArrayList<FileTmpDTO>();
		HashMap indexMap=new HashMap();

		if(sortOrder==null)
			sortOrder="Descending";
		if(sortColName==null)
			sortColName="id";

		map=fileTemplatesService.getAllFileTemplates(offset, limit, formType, request, sortColName, sortOrder);
		fileTmpList=(List<FileTmpDTO>)map.get("fileTmpList");
		//log.info("fileTmpList: "+fileTmpList);
		//		MultIdMap=(HashMap)map.get("MultIdMap");
		//		log.info("MultIdMap: "+MultIdMap);
		int sz=fileTmpList.size(); 
		log.info("fileTmpList sz: "+sz);
		ftIds=(List<Long>)map.get("ftIds"); 
		multIdentifierIds=(List<Long>)map.get("multIdentifierIds"); 
		indexMap=(HashMap) map.get("indexMap"); 
		log.info("ftIds: "+ftIds);
		log.info("indexMap: "+indexMap);
		log.info("multIdentifierIds: "+multIdentifierIds);
		if(formType==null || (formType!=null && !(formType.equalsIgnoreCase("DATA_VIEW")))){
			finList=fileTmpList;
			//log.info("finList: "+finList);
		}
		else if(formType.equalsIgnoreCase("DATA_VIEW")){
			finList.addAll(fileTmpList); 
			fileTmpListWithDfrDivided.addAll(fileTmpList); 

			//Check if File Template List has Multi Row Identifier DFR templates
			int count=0;
			int inde=0;
			int index2=0;
			if(multIdentifierIds!=null && multIdentifierIds.size()>0){

				for(int i=0;i<multIdentifierIds.size();i++)
				{ 
					Long ftId=multIdentifierIds.get(i); 
					log.info("ftId: "+ftId);
					FileTemplates ft=fileTemplatesRepository.findOne(ftId);
					if(i>0)
					{ 
						//log.info("index: "+inde+" count: "+count); 
						inde=index2+count; 
					}

					index2=Integer.parseInt(indexMap.get(ftId).toString()); 
					log.info("index2: "+index2);
					//log.info("fileTmpListWithDfrDivided: "+fileTmpListWithDfrDivided);
					FileTmpDTO ftDto=fileTmpListWithDfrDivided.get(index2); 
					log.info("ftDto: "+ftDto);
					log.info("inde b4: "+inde);
					if(i==0){
						inde=index2;
					}
					log.info("inde aftr: "+inde);
					log.info("finList sz: "+finList.size());
					finList.remove(inde); 
						//log.info("fileTmpListWithDfrDivided aftr removing dfr template: "+finList.size());
						log.info("finList at inde: "+inde+" is: "+finList.get(inde).getTemplateName());
					List<IntermediateTable> itList=intermediateTableRepository.findByTemplateId(ftId); 
					log.info("itList: "+itList);
					log.info("itList size for ftId: "+itList.size());
					String rowIdentifier="";
					HashMap MultIdMap=new HashMap();
					MultIdMap=(HashMap)map.get("MultIdMap");
					log.info("MultIdMap: "+MultIdMap);
					FileTmpDTO dto=new FileTmpDTO();
					dto=(FileTmpDTO) MultIdMap.get(ftId);
					String templateName=ft.getTemplateName();
					log.info("templateName: "+templateName);
					List<FileTmpDTO> finListNew=new ArrayList<FileTmpDTO>();

					for(int j=0;j<itList.size();j++)
					{
						FileTmpDTO fnw = new FileTmpDTO();

						IntermediateTable it=itList.get(j); 
						Long intermediateId=it.getId();
						rowIdentifier=it.getRowIdentifier(); 

						log.info("TemplateName: "+templateName+" rowIdentifier: "+rowIdentifier+" intermediateId: "+intermediateId);

						String dfrTempName=templateName+"-["+rowIdentifier+"]";
						dto.setTemplateName(dfrTempName);

						fnw.setId(dto.getId());
						fnw.setTemplateName(dfrTempName);
						fnw.setDescription(dto.getDescription());
						fnw.setStartDate(dto.getStartDate());
						fnw.setEndDate(dto.getEndDate());
						fnw.setStatus(dto.getStatus());
						fnw.setFileType(dto.getFileType());
						fnw.setDelimiter(dto.getDelimiter());
						fnw.setSource(dto.getSource());
						fnw.setSkipRowsStart(dto.getSkipRowsStart());
						fnw.setSkipRowsEnd(dto.getSkipRowsEnd());
						fnw.setNumberOfColumns(dto.getNumberOfColumns());
						fnw.setHeaderRowNumber(dto.getHeaderRowNumber());
						fnw.setTenantId(dto.getTenantId());
						fnw.setCreatedBy(dto.getCreatedBy());
						fnw.setCreatedDate(dto.getCreatedDate());
						fnw.setLastUpdatedBy(dto.getLastUpdatedBy());
						fnw.setLastUpdatedDate(dto.getLastUpdatedDate());
						fnw.setData(dto.getData());
						fnw.setSdFilename(dto.getSdFilename());
						fnw.setRowIdentifier(rowIdentifier);
						fnw.setEndDated(dto.getEndDated());
						fnw.setMultipleIdentifier(dto.getMultipleIdentifier());
						fnw.setIndex(dto.getIndex());
						fnw.setIntermediateId(intermediateId);
						log.info("====== fnw: "+fnw);
						finListNew.add(fnw); 

						rowIdentifier="";
					}
					log.info("finListNew size: "+finListNew.size()+" itList.size(): "+itList.size());
					for(int k=0;k<itList.size() && k<finListNew.size();k++)
					{
						//log.info("inde: "+inde);
						//log.info("finListNew:"+finListNew.get(k));
						finList.add(inde, finListNew.get(k));
						//log.info("finList: "+finList);
						inde=inde+1;
						count=count+1; 
					}
				}
			}
			log.info("finList sz: "+finList.size());
			finList=finList.subList(0, sz);
		}
		return finList;
	}*/

	/** 
	 * Author Kiran
	 * @param sourceProfileId
	 * @param offset
	 * @param sortColName
	 * @param sortOrder
	 * @param limit
	 * @return
	 * @throws SQLException
	 */
	@GetMapping("/fileTemplateswithStatus")
	@Timed
	public List<HashMap> fetchFileTemplatesWithStatusKiran(@RequestParam(value="sourceProfileId") Long sourceProfileId, @RequestParam(value = "page" , required = false) Integer offset,
			@RequestParam(required = false) String sortColName, @RequestParam(required = false) String sortOrder,@RequestParam(value = "per_page", required = false) Integer limit) throws SQLException
			{
		Connection conn = null;
		Statement stmt = null;
		ResultSet result = null; 
		String schemaName=null;
		List<HashMap> dataMap = new ArrayList<HashMap>();
		try{
			String dbUrl=env.getProperty("spring.datasource.url");
			String[] parts=dbUrl.split("[\\s@&?$+-]+");
			String host = parts[0].split("/")[2].split(":")[0];
			schemaName=parts[0].split("/")[3];
			String userName = env.getProperty("spring.datasource.username");
			String password = env.getProperty("spring.datasource.password");
			String jdbcDriver = env.getProperty("spring.datasource.jdbcdriver");
			Class.forName(jdbcDriver);
			conn = DriverManager.getConnection(dbUrl, userName, password);
			stmt = conn.createStatement();
			log.info("Successfully connected to JDBC with schema "+schemaName);

			//HashMap map=userJdbcService.getuserInfoFromToken(request);
			//Long tenantId=Long.parseLong(map.get("tenantId").toString());
			if(limit == null || limit == 0 )
			{
				limit = sourceProfileFileAssignmentsRepository.findBySourceProfileId(sourceProfileId).size();
			}
			if(offset == null )
			{
				offset=0;
			}
			if(sortOrder==null)
				sortOrder="desc";
			if(sortColName==null)
				sortColName="SPAid";
			int offSt = 0;
			offSt = (offset * limit + 1)-1;
			String query = "";

			//create view 
			//			String view="CREATE OR REPLACE VIEW `profileAsmts_and_templates` AS SELECT `spfa`.`id` AS `AsmtId`, `spfa`.`source_directory_path` AS `sourceDirectoryPath`, `spfa`.`local_directory_path` As`LocalDirectoryPath`, `ft`.`id` AS `ftId`, `ft`.`template_name` AS `templateName` , ( select count(*) from `t_source_profile_file_assignments` where source_profile_id= "+sourceProfileId+") AS `count` FROM  ((`t_source_profile_file_assignments` `spfa`  JOIN `t_file_templates` `ft`)  )  WHERE  (`spfa`.`template_id` =  `ft`.`id` ) and `spfa`.source_profile_id = "+sourceProfileId;

			String view="CREATE OR REPLACE VIEW `profileAsmts_and_templates` AS SELECT "
					+ "`spfa`.`id` AS `SPAid`, "
					+ "`spfa`.`source_profile_id` AS `sourceProfileId`, "
					+ "`spfa`.`file_name_format` AS `fileNameFormat`, "
					+ "`spfa`.`file_extension` AS `fileExtension`, "
					+ "`spfa`.`file_description` AS `fileDescription`, "
					+ "`spfa`.`template_id` AS `templateId`, "
					+ "`spfa`.`hold` AS `hold`, "
					+ "`spfa`.`hold_reason` AS `holdReason`, "
					+ "`spfa`.`source_directory_path` AS `sourceDirectoryPath`, "
					+ "`spfa`.`local_directory_path` As`localDirectoryPath`, "
					+ "`ft`.`template_name` AS `templateName` , "
					+ "`ft`.`status` AS `templateStatus`, "
					+ "`ft`.`id` AS `ftId`, "
					+ "( select count(*) from `t_source_profile_file_assignments` "
					+ "where source_profile_id= "+sourceProfileId+") AS `count` FROM  ((`t_source_profile_file_assignments` `spfa`  JOIN `t_file_templates` `ft`)  )  WHERE  (`spfa`.`template_id` =  `ft`.`id` ) and `spfa`.source_profile_id = "+sourceProfileId; 


			stmt.executeUpdate(view);
			log.info("sortColName: "+sortColName+" sortOrder: "+sortOrder+" offSt: "+offSt+" limit: "+limit);
			query ="SELECT * from "+schemaName+".`"+"profileAsmts_and_templates"+"` "+" order by "+sortColName +" "+sortOrder +" limit "+offSt+", "+limit;
			log.info("query: "+query);
			result=stmt.executeQuery(query);
			log.info("query"+query);
			ResultSetMetaData rsmd = result.getMetaData();
			int colCount = rsmd.getColumnCount();
			while(result.next()){
				HashMap hm = new HashMap();
				for(int i=1; i<=colCount; i++)
				{
					hm.put(rsmd.getColumnName(i), result.getString(i));
				}
				dataMap.add(hm);
			}
			log.info("Data Size: "+ dataMap.size());
		}
		catch(Exception e)
		{
			log.info("Exceptin while fetching data: "+ e);
		}
		finally
		{
			//drop view
			stmt.executeUpdate( "DROP view `"+schemaName+"`.`profileAsmts_and_templates`");

			if(result != null)
				result.close();	
			if(stmt != null)
				stmt.close();
			if(conn != null)
				conn.close();
		}
		return dataMap;}

	@GetMapping("/templatesForTenant")
	@Timed
	public List<FileTemplates> fetchTemplatesForTenant(HttpServletRequest request) throws SQLException
	{
		List<FileTemplates> fileTemps = new ArrayList<FileTemplates>();
		HashMap map=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map.get("tenantId").toString());
		log.info("Request fetch templates For Tenant: "+tenantId);
		fileTemps = fileTemplatesRepository.findByTenantId(tenantId);
		return fileTemps;
	}

	/**
	 * Author1: Ravali
	 * Author2: Swetha [Added DFR specific template retrieval]
	 * GET  /file-templates : get all the fileTemplates.
	 *
	 * @param pageable the pagination information
	 * @return the ResponseEntity with status 200 (OK) and the list of fileTemplates in body
	 * @throws URISyntaxException 
	 */
	@SuppressWarnings("unchecked")
	@GetMapping("/fileTemplatesByTenantId")
	@Timed
	public List<FileTmpDTO> getAllFileTemplatesDfr(@RequestParam(value = "page" , required = false) Integer offset,
			@RequestParam(value = "per_page", required = false) Integer limit, @RequestParam(required = false) String formType, HttpServletRequest request,
			@RequestParam(required = false) String sortColName, @RequestParam(required = false) String sortOrder) throws URISyntaxException {
		HashMap map0=userJdbcService.getuserInfoFromToken(request);
		Long tenantId=Long.parseLong(map0.get("tenantId").toString());
		log.debug("REST request to get a page of FileTemplates with formType: "+formType+" and tenant" +tenantId);

		HashMap map=new HashMap();
		List<FileTmpDTO> fileTmpList=new ArrayList<FileTmpDTO>();
		List<Long> ftIds=new ArrayList<Long>();
		List<Long> multIdentifierIds=new ArrayList<Long>();
		List<FileTmpDTO> fileTmpListWithDfrDivided=new ArrayList<FileTmpDTO>();
		List<FileTmpDTO> finList=new ArrayList<FileTmpDTO>();
		HashMap indexMap=new HashMap();

		if(sortOrder==null)
			sortOrder="Descending";
		if(sortColName==null)
			sortColName="id";

		map=fileTemplatesService.getAllFileTemplates(offset, limit, formType, tenantId, sortColName, sortOrder);
		fileTmpList=(List<FileTmpDTO>)map.get("fileTmpList");
		//log.info("fileTmpList: "+fileTmpList);
		//		MultIdMap=(HashMap)map.get("MultIdMap");
		//		log.info("MultIdMap: "+MultIdMap);
		int sz=fileTmpList.size(); 
		log.info("fileTmpList sz: "+sz);
		ftIds=(List<Long>)map.get("ftIds"); 
		multIdentifierIds=(List<Long>)map.get("multIdentifierIds"); 
		indexMap=(HashMap) map.get("indexMap"); 
		log.info("ftIds: "+ftIds);
		log.info("indexMap: "+indexMap);
		log.info("multIdentifierIds: "+multIdentifierIds);
		HashMap MultIdMap=new HashMap();
		MultIdMap=(HashMap)map.get("MultIdMap");
		//log.info("MultIdMap: "+MultIdMap);
		if(formType==null || (formType!=null && !(formType.equalsIgnoreCase("DATA_VIEW")))){
			finList=fileTmpList;
			//log.info("finList: "+finList);
		}
		else if(formType.equalsIgnoreCase("DATA_VIEW")){
			finList.addAll(fileTmpList); 
			fileTmpListWithDfrDivided.addAll(fileTmpList); 

			//Check if File Template List has Multi Row Identifier DFR templates
			/*int count=0;
			int inde=0;
			int index2=0;*/
			if(multIdentifierIds!=null && multIdentifierIds.size()>0){

				for(int i=0;i<multIdentifierIds.size();i++)
				{ 
					Long ftId=multIdentifierIds.get(i); 
					log.info("ftId: "+ftId);
					FileTemplates ft=fileTemplatesRepository.findOne(ftId);
					/*if(i>0)
					{ 
						//log.info("index: "+inde+" count: "+count); 
						inde=index2+count; 
					}*/

					int index2=Integer.parseInt(indexMap.get(ftId).toString()); 
					log.info("index2: "+index2);
					//log.info("fileTmpListWithDfrDivided: "+fileTmpListWithDfrDivided);
					FileTmpDTO ftDto=fileTmpListWithDfrDivided.get(index2); 
					log.info("ftDto: "+ftDto);
					//log.info("inde b4: "+inde);
					/*if(i==0){
						inde=index2;
					}
					log.info("inde aftr: "+inde);*/
					//log.info("finList B4: "+finList);
					log.info("finList sz: "+finList.size());
					//finList.remove(index2);
					finList.remove(ftDto);
					//log.info("finList aftr@@@@@@@: "+finList);
					//log.info("fileTmpListWithDfrDivided aftr removing dfr template: "+finList.size());
					//log.info("finList at inde: "+inde+" is: "+finList.get(inde).getTemplateName());
					List<IntermediateTable> itList=intermediateTableRepository.findByTemplateId(ftId); 
					//log.info("itList: "+itList);
					log.info("itList size for ftId: "+itList.size());
					String rowIdentifier="";

					FileTmpDTO dto=new FileTmpDTO();
					dto=(FileTmpDTO) MultIdMap.get(ftId);
					String templateName=ft.getTemplateName();
					log.info("templateName: "+templateName);
					List<FileTmpDTO> finListNew=new ArrayList<FileTmpDTO>();

					for(int j=0;j<itList.size();j++)
					{
						FileTmpDTO fnw = new FileTmpDTO();

						IntermediateTable it=itList.get(j); 
						Long intermediateId=it.getId();
						rowIdentifier=it.getRowIdentifier(); 

						log.info("TemplateName: "+templateName+" rowIdentifier: "+rowIdentifier+" intermediateId: "+intermediateId);

						String dfrTempName=templateName+"-"+rowIdentifier;
						dto.setTemplateName(dfrTempName);

						fnw.setId(dto.getId());
						fnw.setTemplateName(dfrTempName);
						fnw.setDescription(dto.getDescription());
						fnw.setStartDate(dto.getStartDate());
						fnw.setEndDate(dto.getEndDate());
						fnw.setStatus(dto.getStatus());
						fnw.setFileType(dto.getFileType());
						fnw.setDelimiter(dto.getDelimiter());
						fnw.setSource(dto.getSource());
						fnw.setSkipRowsStart(dto.getSkipRowsStart());
						fnw.setSkipRowsEnd(dto.getSkipRowsEnd());
						fnw.setNumberOfColumns(dto.getNumberOfColumns());
						fnw.setHeaderRowNumber(dto.getHeaderRowNumber());
						fnw.setTenantId(dto.getTenantId());
						fnw.setCreatedBy(dto.getCreatedBy());
						fnw.setCreatedDate(dto.getCreatedDate());
						fnw.setLastUpdatedBy(dto.getLastUpdatedBy());
						fnw.setLastUpdatedDate(dto.getLastUpdatedDate());
						fnw.setData(dto.getData());
						fnw.setSdFilename(dto.getSdFilename());
						fnw.setRowIdentifier(rowIdentifier);
						fnw.setEndDated(dto.getEndDated());
						fnw.setMultipleIdentifier(dto.getMultipleIdentifier());
						fnw.setIndex(dto.getIndex());
						fnw.setIntermediateId(intermediateId);
						log.info("====== fnw: "+fnw);
						finListNew.add(fnw); 

						rowIdentifier="";
					}
					log.info("finListNew size: "+finListNew.size()+" itList.size(): "+itList.size());
					for(int k=0;k<itList.size() && k<finListNew.size();k++)
					{
						//log.info("inde: "+inde);
						//log.info("finListNew:"+finListNew.get(k));
						finList.add(finListNew.get(k));
						//log.info("finList: "+finList);
						//inde=inde+1;
						//count=count+1; 
					}
				}
			}
			log.info("finList sz: "+finList.size());
			//finList=finList.subList(0, sz);
		}
		return finList;
	}
}
